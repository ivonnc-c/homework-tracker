<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‰ΩúÊ•≠Áπ≥‰∫§ËøΩËπ§Á∏ΩË°® v2.0</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // =======================================================================
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è„Äê ‰ΩøÁî®ËÄÖË®≠ÂÆöÂçÄÂ°ä „Äë‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    // Ë´ãÂ∞á‰∏ãÊñπ firebaseConfig Áâ©‰ª∂ÁöÑÂÖßÂÆπÔºåÊõøÊèõÊàêÊÇ®Ëá™Â∑±Âú® Firebase Â∞àÊ°à‰∏≠ÂèñÂæóÁöÑË®≠ÂÆö„ÄÇ
    // =======================================================================
   const firebaseConfig = {
     apiKey: "AIzaSyACc1hEmcC7GR84_jvtYb2rG5bfErCenCc",
     authDomain: "homeworktracker-32647.firebaseapp.com",
     projectId: "homeworktracker-32647",
     storageBucket: "homeworktracker-32647.firebasestorage.app",
     messagingSenderId: "614728738497",
     appId: "1:614728738497:web:222fcb82c471e7095b5640"
   };
    // =======================================================================
    // ‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è„Äê Ë®≠ÂÆöÂçÄÂ°äÁµêÊùü „Äë‚≠êÔ∏è‚≠êÔ∏è‚≠êÔ∏è
    // =======================================================================

    const getVisitorLink = (classId) => {
      if (!classId) return '';
      return `${window.location.origin}${window.location.pathname}?classId=${classId}`;
    };
    
    const appId = 'super-tracker-default';

    const STATUS_MAP = {
        'default':     { color: 'bg-white border-2 border-gray-400', name: 'Â∞öÊú™Ê™¢Êü•' },
        'submitted':   { color: 'bg-green-500', name: 'Ê∫ñÊôÇÁπ≥‰∫§' },
        'late':        { color: 'bg-yellow-500', name: '‰∫ãÂæåË£ú‰∫§' },
        'unsubmitted': { color: 'bg-red-500', name: 'ÈÄæÊúüÊú™Áπ≥' },
        'ignored':     { color: 'bg-gray-500', name: 'ÂøΩÁï•' },
    };

    const Modal = ({ isOpen, title, children, onClose, footer }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">{title}</h2>
                    <div className="mb-6">{children}</div>
                    {footer && <div className="flex justify-end space-x-3">{footer}</div>}
                </div>
            </div>
        );
    };
    
    const Input = ({ label, id, value, onChange, type = "text", required = false, readOnly = false }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <input id={id} type={type} value={value} onChange={onChange} required={required} readOnly={readOnly} className={`w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`} />
        </div>
    );

    const Textarea = ({ label, id, value, onChange, placeholder, rows = 8 }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <textarea id={id} value={value} onChange={onChange} placeholder={placeholder} rows={rows} className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
    );

    const Button = ({ children, onClick, disabled = false, className = "bg-indigo-600 hover:bg-indigo-700", type = "button" }) => (
        <button onClick={onClick} disabled={disabled} type={type} className={`flex justify-center items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white ${className} disabled:opacity-50 disabled:cursor-not-allowed transition duration-150`}>
            {children}
        </button>
    );

    const StatusCell = ({ status, onClick, isVisitor = false }) => {
        const currentStatus = STATUS_MAP[status] || STATUS_MAP.default;
        const buttonClasses = `w-6 h-6 rounded-full shadow-md mx-auto block ${currentStatus.color}`;
        if (isVisitor) {
            return <td className="border p-1 text-center"><div className={buttonClasses} title={currentStatus.name} /></td>;
        }
        return <td className="border p-1 text-center"><button onClick={onClick} className={`${buttonClasses} transform transition duration-150 active:scale-95`} title={currentStatus.name}/></td>;
    };
    
    const AssignmentHeader = ({ assignment, onEdit, onCopy, onDragStart, onDragOver, onDrop, isDragging, isComplete, isVisitor = false }) => {
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };
        
        const dragStyles = isDragging ? 'opacity-50 border-4 border-indigo-400' : 'opacity-100 border-2 border-transparent';
        const completeStyle = isComplete ? 'bg-green-200' : 'bg-gray-100';
        const cursorStyle = isVisitor ? 'cursor-default' : 'cursor-grab';
        const widthStyle = 'w-24';

        return (
            <th 
                className={`border p-1 text-center text-sm font-semibold text-gray-700 bg-gray-100 ${widthStyle} ${cursorStyle} ${dragStyles} ${completeStyle}`}
                draggable={!isVisitor}
                onDragStart={onDragStart}
                onDragOver={onDragOver}
                onDrop={onDrop}
                data-assignment-id={assignment.id}
            >
                <div className="group relative">
                    <div className={isVisitor ? '' : 'cursor-pointer'} onClick={isVisitor ? null : onEdit}>
                        <p className="font-bold">{assignment.title}</p>
                        <p className="text-xs text-red-500">[{formatDate(assignment.dueDate)}]</p>
                        {isComplete && <p className="text-xs text-green-700 font-bold">[Â∑≤ÂÆåÊàê]</p>}
                    </div>
                    {!isVisitor && (
                        <button onClick={onCopy} className="absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-pink-500 text-white rounded-full p-1 shadow-lg hover:bg-pink-600" title={`Ë§áË£Ω„Äå${assignment.title}„ÄçÁöÑÊú™Áπ≥ÂêçÂñÆ`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-6 4H9m-1 0h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    // üöÄ„ÄêÂäüËÉΩ 3ÔºöÁ¥ÖÁáàÊèêÁ§∫„Äë‰øÆÊîπ StudentCellÔºåÂ¢ûÂä† hasUnsubmitted prop
    const StudentCell = ({ student, onEdit, onCopyDefaulterList, isVisitor = false, getSeatNumber, hasUnsubmitted }) => {
        // Ê±∫ÂÆöÂ∫ïËâ≤ÔºöÂ¶ÇÊûú hasUnsubmitted ÁÇ∫ trueÔºå‰ΩøÁî®Ê∑°Á¥ÖËâ≤
        const baseBg = 'bg-gray-50';
        const warningBg = hasUnsubmitted ? 'bg-red-100' : baseBg;

        return (
            <th className={`border p-1 text-sm text-center font-semibold text-gray-800 sticky left-0 z-10 ${isVisitor ? 'w-16' : 'w-32'} ${warningBg}`}>
                <div className="flex items-center justify-between group px-2">
                    <span className={isVisitor ? '' : 'cursor-pointer hover:underline'} onClick={isVisitor ? null : onEdit}>
                        {isVisitor ? getSeatNumber(student.name) : student.name}
                    </span>
                    {!isVisitor && (
                        <button onClick={onCopyDefaulterList} className="opacity-0 group-hover:opacity-100 transition-opacity text-blue-500 hover:text-blue-700 p-1" title={`${student.name} ÁöÑÁº∫‰∫§Ê∏ÖÂñÆ`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    const AssignmentTable = ({ students, assignments, onStatusChange, getDisplayStatus, onEditStudent, onEditAssignment, onCopyUnsubmitted, onCopyStudentDefaulterList, handleDragStart, handleDragOver, handleDrop, draggedAssignmentId, now, isVisitor = false, getSeatNumber }) => {
        const headerWidthClass = isVisitor ? 'w-16' : 'w-32';
        if (!students || students.length === 0 && (!assignments || assignments.length === 0)) return <div className="p-10 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center text-gray-500 mt-4"><p className="text-xl font-medium mb-2">Ê≠§Áè≠Á¥öÂ∞öÁÑ°Â≠∏ÁîüÊàñ‰ΩúÊ•≠È†ÖÁõÆ</p></div>;
        return (
            <div className="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                <table className="border-collapse table-fixed w-full">
                    <thead>
                        <tr>
                            <th className={`border p-1 text-center font-semibold text-gray-700 bg-gray-100 sticky left-0 z-20 ${headerWidthClass}`}>Â≠∏ÁîüÂ∫ßËôü</th>
                            {assignments.map(assignment => {
                                const isPastDue = assignment.dueDate ? new Date(assignment.dueDate).getTime() < now : false;
                                const isComplete = isPastDue && !students.some(student => getDisplayStatus(student, assignment) === 'unsubmitted');
                                return (
                                    <AssignmentHeader 
                                        key={assignment.id} 
                                        assignment={assignment} 
                                        onEdit={() => onEditAssignment(assignment)} 
                                        onCopy={() => onCopyUnsubmitted(assignment.id)}
                                        onDragStart={(e) => handleDragStart(e, assignment.id)}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, assignment.id)}
                                        isDragging={draggedAssignmentId === assignment.id}
                                        isComplete={isComplete}
                                        isVisitor={isVisitor}
                                    />
                                );
                            })}
                        </tr>
                    </thead>
                    <tbody>
                        {students.map((student, index) => {
                            // üöÄ„ÄêÂäüËÉΩ 3ÔºöÁ¥ÖÁáàÊèêÁ§∫„ÄëÂú®ÈÄôË£°Ë®àÁÆóË©≤ÁîüÊòØÂê¶ÊúâÊú™Áπ≥
                            const hasUnsubmitted = !isVisitor && assignments.some(assignment => getDisplayStatus(student, assignment) === 'unsubmitted');
                            
                            return (
                                <tr key={student.id} className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                    <StudentCell 
                                        student={student} 
                                        onEdit={() => onEditStudent(student)} 
                                        onCopyDefaulterList={() => onCopyStudentDefaulterList(student.id)} 
                                        isVisitor={isVisitor} 
                                        getSeatNumber={getSeatNumber}
                                        hasUnsubmitted={hasUnsubmitted} 
                                    />
                                    {assignments.map(assignment => <StatusCell key={assignment.id} status={getDisplayStatus(student, assignment)} onClick={() => onStatusChange(student, assignment)} isVisitor={isVisitor}/>)}
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };
    
function App() {
        // --- State Variables ---
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [user, setUser] = useState(null);

        const [visitorData, setVisitorData] = useState(null);
        const [isVisitorMode, setIsVisitorMode] = useState(false);
        const [visitorError, setVisitorError] = useState(null);

        const [loginError, setLoginError] = useState('');
        const [classes, setClasses] = useState([]);
        const [activeClassId, setActiveClassId] = useState(null);
        const [students, setStudents] = useState([]);
        const [assignments, setAssignments] = useState([]);
        const [loading, setLoading] = useState({ auth: true, classes: false, data: false, publishing: false });
        const [now, setNow] = useState(new Date().getTime());
        const [modal, setModal] = useState({ type: null, data: null });
        const [statusChangeModal, setStatusChangeModal] = useState({ isOpen: false, student: null, assignment: null });
        const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
        const [isClearCompletedModalOpen, setIsClearCompletedModalOpen] = useState(false);
        const [isSaving, setIsSaving] = useState(false);
        const [isDeleting, setIsDeleting] = useState(false);
        const [formState, setFormState] = useState({});
        const [notification, setNotification] = useState('');
        const [draggedAssignmentId, setDraggedAssignmentId] = useState(null);

        // ‚ú® Êñ∞Â¢ûÔºöÁî®Êñº Email/ÂØÜÁ¢º ÁôªÂÖ•/Ë®ªÂÜäÁöÑÁãÄÊÖã (ÁßªÂà∞È†ÇÂ±§)‚ú®
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [isRegistering, setIsRegistering] = useState(false); // ÊéßÂà∂È°ØÁ§∫ÁôªÂÖ•ÊàñË®ªÂÜäË°®ÂñÆ

        // --- Effects ---
        useEffect(() => {
            const timer = setInterval(() => setNow(new Date().getTime()), 60000);
            return () => clearInterval(timer);
        }, []);

        useEffect(() => {
            // Firebase ÂàùÂßãÂåñ„ÄÅPersistence„ÄÅRedirect Result Ê™¢Êü•„ÄÅAuth ÁãÄÊÖãÁõ£ËÅΩ
            const params = new URLSearchParams(window.location.search);
            const classIdFromUrl = params.get('classId');

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const authInstance = firebase.auth();
            const firestoreInstance = firebase.firestore();

            firestoreInstance.enablePersistence()
              .then(() => console.log("Firebase Èõ¢Á∑öÊ®°ÂºèÂ∑≤ÂïüÁî®."))
              .catch((err) => { /* ...ÁúÅÁï•ÈåØË™§ËôïÁêÜ... */ });

            setAuth(authInstance);
            setDb(firestoreInstance);
            firebase.firestore.setLogLevel('error');

            // Ë®≠ÂÆö Persistence ‰∏¶Ê™¢Êü• Redirect Result
            authInstance.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log("Auth persistence set to LOCAL.");
                    console.log("È†ÅÈù¢ËºâÂÖ•ÔºöÈñãÂßãÊ™¢Êü• getRedirectResult...");
                    return authInstance.getRedirectResult();
                })
                .then((result) => {
                    console.log("getRedirectResult .then() - result:", result);
                    if (result && result.user) {
                       console.log("ÁôªÂÖ•ÊàêÂäü (‰æÜËá™ Redirect):", result.user.uid);
                    } else {
                       console.log("getRedirectResult .then() - Ê≤íÊúâÂÅµÊ∏¨Âà∞ user Áâ©‰ª∂„ÄÇ");
                    }
                })
                .catch((error) => {
                    console.error("Ë®≠ÂÆö Persistence Êàñ getRedirectResult Âá∫ÈåØ:", error);
                    // ...ÁúÅÁï•ÈåØË™§ËôïÁêÜ...
                     setLoginError(`ÁôªÂÖ•Â§±Êïó: ${error.message}`); // Á∞°ÂåñÈåØË™§ÊèêÁ§∫
                });

            // Ê†πÊìö URL Âà§Êñ∑Ê®°Âºè Êàñ Ë®≠ÂÆö Auth ÁãÄÊÖãÁõ£ËÅΩ
            if (classIdFromUrl) {
                setIsVisitorMode(true);
                setLoading(p => ({...p, auth: false, data: true}));
                // ... ÁúÅÁï•Ë®™ÂÆ¢Ë≥áÊñôËÆÄÂèñÈÇèËºØ ...
                 const publicDocRef = firestoreInstance.doc(`artifacts/${appId}/publicData/${classIdFromUrl}`);
                 publicDocRef.get().then(doc => {
                     if (doc.exists) { setVisitorData(doc.data()); }
                     else { setVisitorError('Ê≠§Áè≠Á¥öÁöÑÂÖ¨ÈñãÈ†ÅÈù¢‰∏çÂ≠òÂú®ÊàñÂ∞öÊú™ÁôºÂ∏É„ÄÇ'); }
                 }).catch(err => {
                     console.error("ËÆÄÂèñÂÖ¨ÈñãË≥áÊñôÂ§±Êïó:", err);
                     setVisitorError('ËÆÄÂèñË≥áÊñôÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ®çÂæåÂÜçË©¶„ÄÇ');
                 }).finally(() => { setLoading(p => ({...p, data: false})); });
            } else {
                console.log("È†ÅÈù¢ËºâÂÖ•ÔºöÈñãÂßãË®≠ÂÆö onAuthStateChanged Áõ£ËÅΩÂô®...");
                const unsub = authInstance.onAuthStateChanged((user) => {
                    console.log("onAuthStateChanged Ëß∏Áôº - user:", user ? user.uid : null);
                    setUser(user);
                    // ÁôªÂÖ•ÊàêÂäüÂæåÊ∏ÖÈô§ loginError
                    if (user) setLoginError('');
                    setLoading(prev => ({ ...prev, auth: false }));
                });
                return () => unsub();
            }
        }, []); // ‰øùÊåÅ‰æùË≥¥È†ÖÁÇ∫Á©∫

        // --- Data Fetching Effects (Áè≠Á¥ö, Â≠∏Áîü, ‰ΩúÊ•≠) ---
        // (ÈÄôÂÖ©ÂÄã useEffect ‰øùÊåÅ‰∏çËÆäÔºåÁúÅÁï•...)
        useEffect(() => { /* ... Áè≠Á¥öË≥áÊñôÁõ£ËÅΩ ... */ }, [user, db, isVisitorMode]);
        useEffect(() => { /* ... Â≠∏ÁîüÂèä‰ΩúÊ•≠Ë≥áÊñôÁõ£ËÅΩ ... */ }, [user, activeClassId, db, isVisitorMode]);


        // --- Helper Functions & Callbacks ---
        const getDisplayStatus = useCallback((student, assignment) => { /* ...ÁúÅÁï•... */ }, [now]);
        const showNotification = (message) => { /* ...ÁúÅÁï•... */ };
        const copyToClipboard = (text) => { /* ...ÁúÅÁï•... */ };
        const getSeatNumber = (name) => { /* ...ÁúÅÁï•... */ };
        const handlePublishPublicData = async () => { /* ...ÁúÅÁï•... */ };
        const handleSave = async () => { /* ...ÁúÅÁï•... */ };
        const handleDelete = async () => { /* ...ÁúÅÁï•... */ };
        const handleClearCompletedAssignments = async () => { /* ...ÁúÅÁï•... */ };
        const renderModalTitle = () => { /* ...ÁúÅÁï•... */ };
        const handleDragStart = (e, id) => { /* ...ÁúÅÁï•... */ };
        const handleDragOver = (e) => { /* ...ÁúÅÁï•... */ };
        const handleDrop = async (e, targetId) => { /* ...ÁúÅÁï•... */ };
        const handleSignOut = async () => { /* ...ÁúÅÁï•... */ };
        const executeUpdateStatus = useCallback(async (student, assignment, newState) => { /* ...ÁúÅÁï•... */ }, [db, isVisitorMode]);
        const handleStatusChange = useCallback((student, assignment) => { /* ...ÁúÅÁï•... */ }, [now, executeUpdateStatus, isVisitorMode]);
        const handlePreciseStatusUpdate = async (newState) => { /* ...ÁúÅÁï•... */ };
        const handleCopyUnsubmitted = (assignmentId) => { /* ...ÁúÅÁï•... */ };
        const handleCopyAllUnsubmitted = () => { /* ...ÁúÅÁï•... */ };
        const handleExportMailMergeCSV = () => { /* ...ÁúÅÁï•... */ };
        const handleCopyStudentDefaulterList = (studentId) => { /* ...ÁúÅÁï•... */ };
        const handleFormChange = (e) => { /* ...ÁúÅÁï•... */ };

        // ‚ú® Êñ∞Â¢ûÔºöËôïÁêÜ Email/ÂØÜÁ¢º ÁôªÂÖ•ÁöÑÂáΩÂºè (ÁßªÂà∞È†ÇÂ±§)‚ú®
        const handleEmailSignIn = async (e) => {
          e.preventDefault();
          setLoginError('');
          setIsSaving(true); // ÈñãÂßãËôïÁêÜ
          console.log("ÂòóË©¶ Email ÁôªÂÖ•:", email);
          try {
              if (!auth) throw new Error("È©óË≠âÊ®°ÁµÑÂ∞öÊú™ÂàùÂßãÂåñ");
              await auth.signInWithEmailAndPassword(email, password);
              // ÁôªÂÖ•ÊàêÂäüÂæåÔºåonAuthStateChanged ÊúÉËá™ÂãïËß∏Áôº‰∏¶Êõ¥Êñ∞ user ÁãÄÊÖã
              console.log("Email ÁôªÂÖ•Ë´ãÊ±ÇÊàêÂäü");
          } catch (error) {
              console.error("Email ÁôªÂÖ•Â§±Êïó:", error);
              // Ê†πÊìöÈåØË™§Á¢ºÊèê‰æõÊõ¥ÂèãÂñÑÁöÑÊèêÁ§∫
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                   setLoginError('ÈõªÂ≠êÈÉµ‰ª∂ÊàñÂØÜÁ¢ºÈåØË™§„ÄÇ');
              } else if (error.code === 'auth/invalid-email') {
                   setLoginError('ÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè‰∏çÊ≠£Á¢∫„ÄÇ');
              } else {
                   setLoginError(`ÁôªÂÖ•Â§±ÊïóÔºö${error.message}`);
              }
          } finally {
              setIsSaving(false); // ÁµêÊùüËôïÁêÜ
          }
        };

        // ‚ú® Êñ∞Â¢ûÔºöËôïÁêÜ Email/ÂØÜÁ¢º Ë®ªÂÜäÁöÑÂáΩÂºè (ÁßªÂà∞È†ÇÂ±§)‚ú®
        const handleEmailSignUp = async (e) => {
          e.preventDefault();
          setLoginError('');
          setIsSaving(true); // ÈñãÂßãËôïÁêÜ
          console.log("ÂòóË©¶ Email Ë®ªÂÜä:", email);
           try {
              if (!auth) throw new Error("È©óË≠âÊ®°ÁµÑÂ∞öÊú™ÂàùÂßãÂåñ");
              await auth.createUserWithEmailAndPassword(email, password);
              // Ë®ªÂÜäÊàêÂäüÂæåÔºåonAuthStateChanged ÊúÉËá™ÂãïËß∏Áôº‰∏¶Êõ¥Êñ∞ user ÁãÄÊÖã
              console.log("Email Ë®ªÂÜäÊàêÂäü");
              // ÂèØÈÅ∏ÔºöË®ªÂÜäÊàêÂäüÂæåÊ∏ÖÁ©∫Ë°®ÂñÆ
              // setEmail('');
              // setPassword('');
              // setIsRegistering(false); // ÂàáÂõûÁôªÂÖ•Ê®°Âºè
          } catch (error) {
              console.error("Email Ë®ªÂÜäÂ§±Êïó:", error);
              if (error.code === 'auth/email-already-in-use') {
                  setLoginError('Ê≠§ÈõªÂ≠êÈÉµ‰ª∂Â∑≤Ë¢´Ë®ªÂÜä„ÄÇ');
              } else if (error.code === 'auth/weak-password') {
                  setLoginError('ÂØÜÁ¢ºÂº∑Â∫¶‰∏çË∂≥ÔºåË´ãË®≠ÂÆöËá≥Â∞ëÂÖ≠‰ΩçÊï∏ÁöÑÂØÜÁ¢º„ÄÇ');
              } else if (error.code === 'auth/invalid-email') {
                   setLoginError('ÈõªÂ≠êÈÉµ‰ª∂Ê†ºÂºè‰∏çÊ≠£Á¢∫„ÄÇ');
              } else {
                  setLoginError(`Ë®ªÂÜäÂ§±ÊïóÔºö${error.message}`);
              }
          } finally {
              setIsSaving(false); // ÁµêÊùüËôïÁêÜ
          }
        };

        // ‚ú® Google ÁôªÂÖ•ÂáΩÂºè (‰øùÊåÅ Redirect) ‚ú®
        const handleSignIn = async () => {
            setLoginError('');
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                if (!auth) throw new Error("È©óË≠âÊ®°ÁµÑÂ∞öÊú™ÂàùÂßãÂåñ");
                await auth.signInWithRedirect(provider);
            } catch (error) {
                console.error("Google ÁôªÂÖ•ÈáçÊñ∞Â∞éÂêëÂïüÂãïÂ§±Êïó:", error);
                setLoginError(`ÂïüÂãï Google ÁôªÂÖ•ÊµÅÁ®ãÂ§±Êïó: ${error.message}`);
            }
        };

        // --- Memoized Values ---
        const sortedAssignments = useMemo(() => { /* ...ÁúÅÁï•... */ }, [assignments, students, now, getDisplayStatus]);
        const completedAssignments = useMemo(() => { /* ...ÁúÅÁï•... */ }, [sortedAssignments, students, now, getDisplayStatus]);


        // --- Render Logic ---
        if (loading.auth) {
            return <div className="flex items-center justify-center min-h-screen bg-gray-100"><p className="text-lg text-gray-600">Ê≠£Âú®È©óË≠âÊÇ®ÁöÑË∫´ÂàÜ...</p></div>;
        }

        // üåü ÈáçÊñ∞Êï¥ÁêÜÂæåÁöÑÊ∏≤ÊüìÈÇèËºØ üåü
        // 1. ÂÑ™ÂÖàËôïÁêÜË®™ÂÆ¢Ê®°Âºè
        if (isVisitorMode) {
            if (loading.data) { /* ...È°ØÁ§∫ËºâÂÖ•‰∏≠... */ }
            if (visitorError) { /* ...È°ØÁ§∫ÈåØË™§Ë®äÊÅØ... */ }
            if (visitorData) {
                 // ... ËøîÂõûË®™ÂÆ¢Ê®°ÂºèÁöÑ JSX ...
                 const { className, students: visitorStudents, assignments: visitorAssignments, lastUpdated } = visitorData;
                 const formattedDate = /* ... */;
                 const visitorSortedAssignments = /* ... */;
                 return (
                    <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                        {/* ... Ë®™ÂÆ¢Ê®°ÂºèÁöÑ Header Âíå Main ... */}
                        <header>...</header>
                        <main>
                            <div className="flex justify-end gap-4 mb-2">
                               <Button onClick={() => handleCopyAllUnsubmitted()} className="bg-pink-500 hover:bg-pink-600">Ë§áË£ΩÂÖ®Áè≠Êú™Áπ≥Á∏ΩË°®</Button>
                               <Button onClick={() => handleExportMailMergeCSV()} className="bg-green-600 hover:bg-green-700">ÂåØÂá∫ÂÇ¨Áπ≥Á∏ΩË°® (CSV)</Button>
                           </div>
                            <AssignmentTable
                                students={visitorStudents || []}
                                assignments={visitorSortedAssignments}
                                /* ... ÂÖ∂‰ªñ props ... */
                                isVisitor={true}
                             />
                        </main>
                    </div>
                 );
            }
            return null; // Ëã• visitorData ÈÇÑÊ≤íËºâÂÖ•ÂÆåÊàê
        }

        // 2. ËôïÁêÜÊú™ÁôªÂÖ•ÁãÄÊÖã (È°ØÁ§∫Êñ∞ÁöÑÁôªÂÖ•/Ë®ªÂÜä‰ªãÈù¢)
        if (!user) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-indigo-50 px-4 py-8">
                    <div className="text-center p-8 bg-white rounded-2xl shadow-xl max-w-md w-full">
                        <h1 className="text-3xl font-extrabold text-indigo-700 mb-2">‰ΩúÊ•≠Áπ≥‰∫§ËøΩËπ§Á∏ΩË°®</h1>
                        <p className="text-gray-600 mb-6">‰∏ÄÂÄãÁÇ∫ËÄÅÂ∏´Ë®≠Ë®àÁöÑÈõ≤Á´ØÂêåÊ≠•Â∑•ÂÖ∑</p>
                        <form onSubmit={isRegistering ? handleEmailSignUp : handleEmailSignIn} className="space-y-4 mb-6">
                           {/* ... Email, Password Ëº∏ÂÖ•Ê°Ü ... */}
                            <Input id="email" type="email" label="ÈõªÂ≠êÈÉµ‰ª∂" value={email} onChange={(e)=> setEmail(e.target.value)} required={true} />
                            <Input id="password" type="password" label="ÂØÜÁ¢º" value={password} onChange={(e)=> setPassword(e.target.value)} required={true} />
                            <Button type="submit" className="w-full bg-blue-600 hover:bg-blue-700" disabled={isSaving}>
                                {isSaving ? 'ËôïÁêÜ‰∏≠...' : (isRegistering ? 'Ë®ªÂÜäÊñ∞Â∏≥Ëôü' : 'ÁôªÂÖ•')}
                            </Button>
                        </form>
                        <p className="text-sm text-gray-600 mb-4">
                            {isRegistering ? 'Â∑≤Á∂ìÊúâÂ∏≥Ëôü‰∫ÜÔºü' : 'ÈÇÑÊ≤íÊúâÂ∏≥ËôüÂóéÔºü'}
                            <button onClick={() => { setIsRegistering(!isRegistering); setLoginError(''); }} className="font-medium text-indigo-600 hover:text-indigo-500 ml-1">
                                {isRegistering ? 'ÈªûÊ≠§ÁôªÂÖ•' : 'ÈªûÊ≠§Ë®ªÂÜä'}
                            </button>
                        </p>
                        <div className="relative my-6">{/* ...ÂàÜÈöîÁ∑ö... */}</div>
                        <button onClick={handleSignIn} className="w-full flex items-center justify-center gap-3 px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                            <svg className="w-6 h-6" viewBox="0 0 48 48">...</svg> ‰ΩøÁî® Google Â∏≥ËôüÁôªÂÖ•
                        </button>
                        {loginError && <p className="mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg">{loginError}</p>}
                    </div>
                </div>
            );
        }

        // 3. ËôïÁêÜÂ∑≤ÁôªÂÖ•ÁãÄÊÖã (È°ØÁ§∫‰∏ªÊáâÁî®Á®ãÂºè‰ªãÈù¢)
        const activeClass = classes.find(c => c.id === activeClassId);
        const activeClassName = activeClass?.name || "Áè≠Á¥ö";

        return (
            <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                {notification && (/* ...ÈÄöÁü•... */)}
                <Modal isOpen={isHelpModalOpen} /* ... */ >{/* ...Ë™™ÊòéÂÖßÂÆπ... */}</Modal>
                <Modal isOpen={statusChangeModal.isOpen} /* ... */ >{/* ...ÁãÄÊÖãÊåâÈàï... */}</Modal>
                <Modal isOpen={!!modal.type} /* ... */ >{/* ...Á∑®ËºØ/Êñ∞Â¢ûË°®ÂñÆ... */}</Modal>
                <Modal isOpen={isClearCompletedModalOpen} /* ... */ >{/* ...Ê∏ÖÈô§Á¢∫Ë™ç... */}</Modal>

                <header className="bg-white rounded-xl shadow-lg p-6 mb-6">
                   {/* ... Ê®ôÈ°å„ÄÅÁôªÂá∫ÊåâÈàï„ÄÅË™™Êòé ... */}
                    <div className="flex flex-wrap justify-between items-center gap-4">
                       {/* ... */}
                       <div className="flex items-center gap-3">
                            <span className="text-sm text-gray-600">Ê≠°Ëøé, {user.displayName || user.email || user.uid}</span> {/* È°ØÁ§∫ uid ‰ª•‰æøÁ¢∫Ë™ç */}
                            <button onClick={handleSignOut} className="text-sm text-red-500 hover:underline">ÁôªÂá∫</button>
                        </div>
                    </div>
                    {/* ... Ë™™ÊòéÊñáÂ≠ó ... */}
                    <div className="mt-4 border-t pt-4"> {/* ... Áè≠Á¥öÊåâÈàï ... */} </div>
                </header>

                {loading.classes ? <p>...</p> : !activeClassId && user ? (
                    <div className="p-10 bg-white ...">{/* ... ÊèêÁ§∫Êñ∞Â¢ûÁè≠Á¥ö ... */}</div>
                ) : (
                    <main>
                        <div className="flex flex-wrap justify-between items-center gap-x-4 gap-y-2 mb-2">
                             <h2 className="text-2xl font-bold text-gray-800">{activeClassName}</h2>
                             <div className="flex flex-wrap items-center gap-4">
                               {/* ... Êñ∞Â¢û‰ΩúÊ•≠„ÄÅË§áË£Ω„ÄÅÂåØÂá∫„ÄÅÊ∏ÖÈô§ÊåâÈàï ... */}
                                <Button onClick={handleExportMailMergeCSV} className="bg-green-600 hover:bg-green-700">ÂåØÂá∫ÂÇ¨Áπ≥Á∏ΩË°® (CSV)</Button>
                                {/* ... */}
                             </div>
                        </div>
                        {loading.data ? <p>...</p> : (
                            <>
                                <AssignmentTable students={students} assignments={sortedAssignments} /* ... */ />
                                <div className="mt-4 flex gap-4">{/* ... Êñ∞Â¢ûÂ≠∏ÁîüÊåâÈàï ... */}</div>
                            </>
                        )}
                    </main>
                )}
            </div>
        );
    } // App ÂáΩÊï∏ÁµêÊùü
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js') // Á¢∫‰øùË∑ØÂæëÊòØÊ†πÁõÆÈåÑ
        .then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(error => {
          console.log('ServiceWorker registration failed: ', error);
        });
    });
  }
</script>
</body>
</html>

