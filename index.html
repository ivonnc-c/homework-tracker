<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨ v2.0</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // =======================================================================
    // â­ï¸â­ï¸â­ï¸ã€ ä½¿ç”¨è€…è¨­å®šå€å¡Š ã€‘â­ï¸â­ï¸â­ï¸
    // è«‹å°‡ä¸‹æ–¹ firebaseConfig ç‰©ä»¶çš„å…§å®¹ï¼Œæ›¿æ›æˆæ‚¨è‡ªå·±åœ¨ Firebase å°ˆæ¡ˆä¸­å–å¾—çš„è¨­å®šã€‚
    // =======================================================================
   const firebaseConfig = {
     apiKey: "AIzaSyACc1hEmcC7GR84_jvtYb2rG5bfErCenCc",
     authDomain: "homeworktracker-32647.firebaseapp.com",
     projectId: "homeworktracker-32647",
     storageBucket: "homeworktracker-32647.firebasestorage.app",
     messagingSenderId: "614728738497",
     appId: "1:614728738497:web:222fcb82c471e7095b5640"
   };
    // =======================================================================
    // â­ï¸â­ï¸â­ï¸ã€ è¨­å®šå€å¡ŠçµæŸ ã€‘â­ï¸â­ï¸â­ï¸
    // =======================================================================

    const getVisitorLink = (classId) => {
      if (!classId) return '';
      return `${window.location.origin}${window.location.pathname}?classId=${classId}`;
    };
    
    const appId = 'super-tracker-default';

    const STATUS_MAP = {
        'default':     { color: 'bg-white border-2 border-gray-400', name: 'å°šæœªæª¢æŸ¥' },
        'submitted':   { color: 'bg-green-500', name: 'æº–æ™‚ç¹³äº¤' },
        'late':        { color: 'bg-yellow-500', name: 'äº‹å¾Œè£œäº¤' },
        'unsubmitted': { color: 'bg-red-500', name: 'é€¾æœŸæœªç¹³' },
        'ignored':     { color: 'bg-gray-500', name: 'å¿½ç•¥' },
    };

    const Modal = ({ isOpen, title, children, onClose, footer }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">{title}</h2>
                    <div className="mb-6">{children}</div>
                    {footer && <div className="flex justify-end space-x-3">{footer}</div>}
                </div>
            </div>
        );
    };
    
    const Input = ({ label, id, value, onChange, type = "text", required = false, readOnly = false }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <input id={id} type={type} value={value} onChange={onChange} required={required} readOnly={readOnly} className={`w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`} />
        </div>
    );

    const Textarea = ({ label, id, value, onChange, placeholder, rows = 8 }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <textarea id={id} value={value} onChange={onChange} placeholder={placeholder} rows={rows} className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
    );

    const Button = ({ children, onClick, disabled = false, className = "bg-indigo-600 hover:bg-indigo-700", type = "button" }) => (
        <button onClick={onClick} disabled={disabled} type={type} className={`flex justify-center items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white ${className} disabled:opacity-50 disabled:cursor-not-allowed transition duration-150`}>
            {children}
        </button>
    );

    const StatusCell = ({ status, onClick, isVisitor = false }) => {
        const currentStatus = STATUS_MAP[status] || STATUS_MAP.default;
        const buttonClasses = `w-6 h-6 rounded-full shadow-md mx-auto block ${currentStatus.color}`;
        if (isVisitor) {
            return <td className="border p-1 text-center"><div className={buttonClasses} title={currentStatus.name} /></td>;
        }
        return <td className="border p-1 text-center"><button onClick={onClick} className={`${buttonClasses} transform transition duration-150 active:scale-95`} title={currentStatus.name}/></td>;
    };
    
    const AssignmentHeader = ({ assignment, onEdit, onCopy, onDragStart, onDragOver, onDrop, isDragging, isComplete, isVisitor = false }) => {
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };
        
        const dragStyles = isDragging ? 'opacity-50 border-4 border-indigo-400' : 'opacity-100 border-2 border-transparent';
        const completeStyle = isComplete ? 'bg-green-200' : 'bg-gray-100';
        const cursorStyle = isVisitor ? 'cursor-default' : 'cursor-grab';
        const widthStyle = 'w-24';

        return (
            <th 
                className={`border p-1 text-center text-sm font-semibold text-gray-700 bg-gray-100 ${widthStyle} ${cursorStyle} ${dragStyles} ${completeStyle}`}
                draggable={!isVisitor}
                onDragStart={onDragStart}
                onDragOver={onDragOver}
                onDrop={onDrop}
                data-assignment-id={assignment.id}
            >
                <div className="group relative">
                    <div className={isVisitor ? '' : 'cursor-pointer'} onClick={isVisitor ? null : onEdit}>
                        <p className="font-bold">{assignment.title}</p>
                        <p className="text-xs text-red-500">[{formatDate(assignment.dueDate)}]</p>
                        {isComplete && <p className="text-xs text-green-700 font-bold">[å·²å®Œæˆ]</p>}
                    </div>
                    {!isVisitor && (
                        <button onClick={onCopy} className="absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-pink-500 text-white rounded-full p-1 shadow-lg hover:bg-pink-600" title={`è¤‡è£½ã€Œ${assignment.title}ã€çš„æœªç¹³åå–®`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-6 4H9m-1 0h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    // ğŸš€ã€åŠŸèƒ½ 3ï¼šç´…ç‡ˆæç¤ºã€‘ä¿®æ”¹ StudentCellï¼Œå¢åŠ  hasUnsubmitted prop
    const StudentCell = ({ student, onEdit, onCopyDefaulterList, isVisitor = false, getSeatNumber, hasUnsubmitted }) => {
        // æ±ºå®šåº•è‰²ï¼šå¦‚æœ hasUnsubmitted ç‚º trueï¼Œä½¿ç”¨æ·¡ç´…è‰²
        const baseBg = 'bg-gray-50';
        const warningBg = hasUnsubmitted ? 'bg-red-100' : baseBg;

        return (
            <th className={`border p-1 text-sm text-center font-semibold text-gray-800 sticky left-0 z-10 ${isVisitor ? 'w-16' : 'w-32'} ${warningBg}`}>
                <div className="flex items-center justify-between group px-2">
                    <span className={isVisitor ? '' : 'cursor-pointer hover:underline'} onClick={isVisitor ? null : onEdit}>
                        {isVisitor ? getSeatNumber(student.name) : student.name}
                    </span>
                    {!isVisitor && (
                        <button onClick={onCopyDefaulterList} className="opacity-0 group-hover:opacity-100 transition-opacity text-blue-500 hover:text-blue-700 p-1" title={`${student.name} çš„ç¼ºäº¤æ¸…å–®`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    const AssignmentTable = ({ students, assignments, onStatusChange, getDisplayStatus, onEditStudent, onEditAssignment, onCopyUnsubmitted, onCopyStudentDefaulterList, handleDragStart, handleDragOver, handleDrop, draggedAssignmentId, now, isVisitor = false, getSeatNumber }) => {
        const headerWidthClass = isVisitor ? 'w-16' : 'w-32';
        if (!students || students.length === 0 && (!assignments || assignments.length === 0)) return <div className="p-10 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center text-gray-500 mt-4"><p className="text-xl font-medium mb-2">æ­¤ç­ç´šå°šç„¡å­¸ç”Ÿæˆ–ä½œæ¥­é …ç›®</p></div>;
        return (
            <div className="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                <table className="border-collapse table-fixed w-full">
                    <thead>
                        <tr>
                            <th className={`border p-1 text-center font-semibold text-gray-700 bg-gray-100 sticky left-0 z-20 ${headerWidthClass}`}>å­¸ç”Ÿåº§è™Ÿ</th>
                            {assignments.map(assignment => {
                                const isPastDue = assignment.dueDate ? new Date(assignment.dueDate).getTime() < now : false;
                                const isComplete = isPastDue && !students.some(student => getDisplayStatus(student, assignment) === 'unsubmitted');
                                return (
                                    <AssignmentHeader 
                                        key={assignment.id} 
                                        assignment={assignment} 
                                        onEdit={() => onEditAssignment(assignment)} 
                                        onCopy={() => onCopyUnsubmitted(assignment.id)}
                                        onDragStart={(e) => handleDragStart(e, assignment.id)}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, assignment.id)}
                                        isDragging={draggedAssignmentId === assignment.id}
                                        isComplete={isComplete}
                                        isVisitor={isVisitor}
                                    />
                                );
                            })}
                        </tr>
                    </thead>
                    <tbody>
                        {students.map((student, index) => {
                            // ğŸš€ã€åŠŸèƒ½ 3ï¼šç´…ç‡ˆæç¤ºã€‘åœ¨é€™è£¡è¨ˆç®—è©²ç”Ÿæ˜¯å¦æœ‰æœªç¹³
                            const hasUnsubmitted = !isVisitor && assignments.some(assignment => getDisplayStatus(student, assignment) === 'unsubmitted');
                            
                            return (
                                <tr key={student.id} className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                    <StudentCell 
                                        student={student} 
                                        onEdit={() => onEditStudent(student)} 
                                        onCopyDefaulterList={() => onCopyStudentDefaulterList(student.id)} 
                                        isVisitor={isVisitor} 
                                        getSeatNumber={getSeatNumber}
                                        hasUnsubmitted={hasUnsubmitted} 
                                    />
                                    {assignments.map(assignment => <StatusCell key={assignment.id} status={getDisplayStatus(student, assignment)} onClick={() => onStatusChange(student, assignment)} isVisitor={isVisitor}/>)}
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };
    
    function App() {
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [user, setUser] = useState(null);
        
        const [visitorData, setVisitorData] = useState(null);
        const [isVisitorMode, setIsVisitorMode] = useState(false);
        const [visitorError, setVisitorError] = useState(null);

        const [loginError, setLoginError] = useState('');
        const [classes, setClasses] = useState([]);
        const [activeClassId, setActiveClassId] = useState(null);
        const [students, setStudents] = useState([]);
        const [assignments, setAssignments] = useState([]);
        const [loading, setLoading] = useState({ auth: true, classes: false, data: false, publishing: false });
        const [now, setNow] = useState(new Date().getTime());
        const [modal, setModal] = useState({ type: null, data: null });
        const [statusChangeModal, setStatusChangeModal] = useState({ isOpen: false, student: null, assignment: null });
        const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
        const [isClearCompletedModalOpen, setIsClearCompletedModalOpen] = useState(false);
        const [isSaving, setIsSaving] = useState(false);
        const [isDeleting, setIsDeleting] = useState(false);
        const [formState, setFormState] = useState({});
        const [notification, setNotification] = useState('');
        const [draggedAssignmentId, setDraggedAssignmentId] = useState(null);
        
        useEffect(() => {
            const timer = setInterval(() => setNow(new Date().getTime()), 60000);
            return () => clearInterval(timer);
        }, []);

        useEffect(() => {
            const params = new URLSearchParams(window.location.search);
            const classIdFromUrl = params.get('classId');
            
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const authInstance = firebase.auth();
            const firestoreInstance = firebase.firestore();

            // ğŸš€ã€åŠŸèƒ½ 1ï¼šå•Ÿç”¨é›¢ç·šåŠŸèƒ½ã€‘
            firestoreInstance.enablePersistence()
              .then(() => {
                console.log("Firebase é›¢ç·šæ¨¡å¼å·²å•Ÿç”¨ã€‚");
              })
              .catch((err) => {
                if (err.code == 'failed-precondition') {
                  console.warn("Firebase é›¢ç·šåŠŸèƒ½å•Ÿç”¨å¤±æ•—ï¼šå¯èƒ½å·²åœ¨å…¶ä»–åˆ†é é–‹å•Ÿã€‚");
                } else if (err.code == 'unimplemented') {
                  console.log("Firebase é›¢ç·šåŠŸèƒ½ï¼šç›®å‰ç€è¦½å™¨ä¸æ”¯æ´ã€‚");
                }
              });
            // ã€åŠŸèƒ½ 1 çµæŸã€‘

            setAuth(authInstance);
            setDb(firestoreInstance);
            firebase.firestore.setLogLevel('error');
            
            if (classIdFromUrl) {
                setIsVisitorMode(true);
                setLoading(p => ({...p, auth: false, data: true}));
                const publicDocRef = firestoreInstance.doc(`artifacts/${appId}/publicData/${classIdFromUrl}`);
                publicDocRef.get().then(doc => {
                    if (doc.exists) {
                        setVisitorData(doc.data());
                    } else {
                        setVisitorError('æ­¤ç­ç´šçš„å…¬é–‹é é¢ä¸å­˜åœ¨æˆ–å°šæœªç™¼å¸ƒã€‚');
                    }
                }).catch(err => {
                    console.error("è®€å–å…¬é–‹è³‡æ–™å¤±æ•—:", err);
                    setVisitorError('è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                }).finally(() => {
                    setLoading(p => ({...p, data: false}));
                });
            } else {
               const unsub = authInstance.onAuthStateChanged((user) => {
                    setUser(user);
                    setLoading(prev => ({ ...prev, auth: false }));
                });
                return () => unsub();
            }
        }, []);

        useEffect(() => {
            if (isVisitorMode || !user || !db) {
                setClasses([]);
                setActiveClassId(null);
                return;
            }
            setLoading(p => ({ ...p, classes: true }));
            const q = db.collection(`artifacts/${appId}/public/data/classes`).where("userId", "==", user.uid);
            const unsub = q.onSnapshot((snapshot) => {
                const fetched = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a, b) => (a.createdAt?.toMillis() || 0) - (b.createdAt?.toMillis() || 0));
                setClasses(fetched);
                if (!activeClassId || !fetched.some(c => c.id === activeClassId)) {
                    setActiveClassId(fetched[0]?.id || null);
                }
                setLoading(p => ({ ...p, classes: false }));
            }, err => {
                console.error("ç­ç´šç›£è½å¤±æ•—:", err);
                setLoading(p => ({ ...p, classes: false }));
            });
            return () => unsub();
        }, [user, db, isVisitorMode]);

        useEffect(() => {
            if (isVisitorMode || !user || !activeClassId || !db) { 
                setStudents([]); 
                setAssignments([]); 
                return; 
            }
            setLoading(p => ({ ...p, data: true }));
            const sQuery = db.collection(`artifacts/${appId}/public/data/students`).where("classId", "==", activeClassId).where("userId", "==", user.uid);
            const aQuery = db.collection(`artifacts/${appId}/public/data/assignments`).where("classId", "==", activeClassId).where("userId", "==", user.uid);

            const unsubS = sQuery.onSnapshot(snap => {
                const fetchedStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                fetchedStudents.sort((a, b) => {
                    const numA = parseInt(a.name.match(/^\d+/)?.[0] || '9999', 10);
                    const numB = parseInt(b.name.match(/^\d+/)?.[0] || '9999', 10);
                    if (numA !== numB) return numA - numB;
                    return a.name.localeCompare(b.name, 'zh-Hant');
                });
                setStudents(fetchedStudents);
            }, err => {
                console.error("å­¸ç”Ÿè³‡æ–™ç›£è½å¤±æ•—:", err);
                showNotification('è®€å–å­¸ç”Ÿè³‡æ–™å¤±æ•—ã€‚');
                setLoading(p => ({ ...p, data: false }));
            });

            const unsubA = aQuery.onSnapshot(snap => {
                const fetchedAssignments = snap.docs.map(d => ({id: d.id, ...d.data()}));
                setAssignments(fetchedAssignments);
                setLoading(p => ({ ...p, data: false }));
            }, err => {
                console.error("ä½œæ¥­è³‡æ–™ç›£è½å¤±æ•—:", err);
                showNotification('è®€å–ä½œæ¥­è³‡æ–™å¤±æ•—ã€‚');
                setLoading(p => ({ ...p, data: false }));
            });
            
            return () => { unsubS(); unsubA(); };
        }, [user, activeClassId, db, isVisitorMode]);
        
        const getDisplayStatus = useCallback((student, assignment) => {
            const statusObj = student.statuses?.[assignment.id] || { state: 'default' };
            if (statusObj.state !== 'default') return statusObj.state;

            let dueDateTime = Infinity;
            if (assignment.dueDate) {
                if (assignment.dueDate.seconds) {
                    dueDateTime = new Date(assignment.dueDate.seconds * 1000).getTime();
                } else {
                    dueDateTime = new Date(assignment.dueDate).getTime();
                }
            }
            
            return dueDateTime < now ? 'unsubmitted' : 'default';
        }, [now]);

        const sortedAssignments = useMemo(() => {
            if (!assignments.length) return [];
            return [...assignments].sort((a, b) => {
                const isPastDueA = a.dueDate ? new Date(a.dueDate?.seconds ? a.dueDate.seconds * 1000 : a.dueDate).getTime() < now : false;
                const isCompleteA = isPastDueA && !students.some(student => getDisplayStatus(student, a) === 'unsubmitted');
                const isPastDueB = b.dueDate ? new Date(b.dueDate?.seconds ? b.dueDate.seconds * 1000 : b.dueDate).getTime() < now : false;
                const isCompleteB = isPastDueB && !students.some(student => getDisplayStatus(student, b) === 'unsubmitted');
                if (isCompleteA && !isCompleteB) return 1;
                if (!isCompleteA && isCompleteB) return -1;
                return (a.order || 0) - (b.order || 0);
            });
        }, [assignments, students, now, getDisplayStatus]);
        
        const completedAssignments = useMemo(() => {
            return sortedAssignments.filter(assignment => {
                const isPastDue = assignment.dueDate ? new Date(assignment.dueDate?.seconds ? assignment.dueDate.seconds * 1000 : assignment.dueDate).getTime() < now : false;
                if (!isPastDue) return false;
                return !students.some(student => getDisplayStatus(student, assignment) === 'unsubmitted');
            });
        }, [sortedAssignments, students, now, getDisplayStatus]);

        const showNotification = (message) => {
            setNotification(message);
            setTimeout(() => setNotification(''), 3000);
        };

        const copyToClipboard = (text) => {
            navigator.clipboard.writeText(text).then(() => {
                showNotification('æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼');
            }, () => {
                showNotification('è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚');
            });
        };

        const getSeatNumber = (name) => {
            const num = name.match(/^\d+/)?.[0];
            return num ? String(num).padStart(2, '0') : name;
        };

        const handlePublishPublicData = async () => {
            if (!db || !activeClassId || students.length === 0) {
                showNotification('æ²’æœ‰è³‡æ–™å¯ç™¼å¸ƒï¼');
                return;
            }
            setLoading(p => ({ ...p, publishing: true }));
            
            const activeClassName = classes.find(c => c.id === activeClassId)?.name || '';

            const publicDataPayload = {
                className: activeClassName,
                students: students,
                assignments: assignments,
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };

            try {
                const publicDocRef = db.doc(`artifacts/${appId}/publicData/${activeClassId}`);
                await publicDocRef.set(publicDataPayload);
                showNotification(`æˆåŠŸæ›´æ–°ã€Œ${activeClassName}ã€çš„å…¬é–‹é é¢ï¼`);
            } catch (error) {
                console.error("ç™¼å¸ƒå…¬é–‹è³‡æ–™å¤±æ•—:", error);
                showNotification(`ç™¼å¸ƒå¤±æ•—: ${error.message}`);
            } finally {
                setLoading(p => ({ ...p, publishing: false }));
            }
        };

        const handleSave = async () => {
            if (!db || !user || !modal.type) return;
            setIsSaving(true);
            try {
                if (modal.type === 'student' && !modal.data) {
                    const existingNames = new Set(students.map(s => s.name));
                    const names = formState.studentList.split('\n').map(name => name.trim()).filter(Boolean);
                    const uniqueNewNames = [...new Set(names)].filter(name => !existingNames.has(name));
                    if (uniqueNewNames.length > 0) {
                        const batch = db.batch();
                        const ref = db.collection(`artifacts/${appId}/public/data/students`);
                        uniqueNewNames.forEach((name) => {
                            const newDocRef = ref.doc();
                            batch.set(newDocRef, { name, classId: activeClassId, userId: user.uid, createdAt: firebase.firestore.FieldValue.serverTimestamp(), statuses: {} });
                        });
                        await batch.commit();
                    }
                } else {
                    const collectionNameMap = { class: 'classes', student: 'students', assignment: 'assignments' };
                    const collectionName = collectionNameMap[modal.type];
                    if (!collectionName) {
                        setIsSaving(false);
                        return;
                    };
                    const basePath = `artifacts/${appId}/public/data/${collectionName}`;
                    if (modal.data) {
                        await db.doc(`${basePath}/${modal.data.id}`).update(formState);
                    } else {
                        let data = { ...formState, userId: user.uid, classId: activeClassId, createdAt: firebase.firestore.FieldValue.serverTimestamp() };
                        if (modal.type === 'class') {
                            delete data.classId; 
                        } else {
                            const existingOrders = assignments.map(a => a.order || 0);
                            const minOrder = assignments.length > 0 ? Math.min(...existingOrders) : 0;
                            data.order = minOrder - 1;
                        }
                        await db.collection(basePath).add(data);
                    }
                }
                setModal({ type: null, data: null });
            } catch (error) { console.error("å„²å­˜å¤±æ•—:", error); showNotification(`å„²å­˜å¤±æ•—: ${error.message}`); } 
            finally { setIsSaving(false); }
        };
        
        const handleDelete = async () => {
            if (!db || !user || !modal.type || !modal.data) return;
            setIsDeleting(true);
            try {
                if (modal.type === 'class') {
                    const batch = db.batch();
                    const classIdToDelete = modal.data.id;

                    const sQuery = db.collection(`artifacts/${appId}/public/data/students`).where("classId", "==", classIdToDelete).where("userId", "==", user.uid);
                    const aQuery = db.collection(`artifacts/${appId}/public/data/assignments`).where("classId", "==", classIdToDelete).where("userId", "==", user.uid);
                    
                    const [sSnap, aSnap] = await Promise.all([sQuery.get(), aQuery.get()]);
                    
                    sSnap.forEach(d => batch.delete(d.ref));
                    aSnap.forEach(d => batch.delete(d.ref));
                    
                    batch.delete(db.doc(`artifacts/${appId}/public/data/classes/${classIdToDelete}`));
                    batch.delete(db.doc(`artifacts/${appId}/publicData/${classIdToDelete}`));

                    await batch.commit();
                    
                    const remainingClasses = classes.filter(c => c.id !== classIdToDelete);
                    setActiveClassId(remainingClasses.length > 0 ? remainingClasses[0].id : null);
                    showNotification(`ç­ç´š ${modal.data.name} åŠå…¶æ‰€æœ‰è³‡æ–™å·²æˆåŠŸåˆªé™¤ï¼`);

                } else if (modal.type === 'student') {
                   await db.doc(`artifacts/${appId}/public/data/students/${modal.data.id}`).delete();
                } else if (modal.type === 'assignment') { 
                    const batch = db.batch();
                    const id = modal.data.id;
                    students.forEach(s => {
                        if (s.statuses?.[id]) {
                            const studentRef = db.doc(`artifacts/${appId}/public/data/students/${s.id}`);
                            batch.update(studentRef, { [`statuses.${id}`]: firebase.firestore.FieldValue.delete() });
                        }
                    });
                    batch.delete(db.doc(`artifacts/${appId}/public/data/assignments/${id}`));
                    await batch.commit();
                }
                setModal({ type: null, data: null });
            } catch (error) { 
                console.error("åˆªé™¤å¤±æ•—:", error); 
                showNotification(`åˆªé™¤å¤±æ•—: ${error.message}`); 
            } finally { 
                setIsDeleting(false); 
            }
        };

        const handleClearCompletedAssignments = async () => {
            if (!db || completedAssignments.length === 0) return;
            setIsDeleting(true);
            try {
                const batch = db.batch();
                const assignmentIdsToDelete = completedAssignments.map(a => a.id);
                assignmentIdsToDelete.forEach(id => {
                    const assignmentRef = db.doc(`artifacts/${appId}/public/data/assignments/${id}`);
                    batch.delete(assignmentRef);
                    students.forEach(student => {
                        if (student.statuses && student.statuses[id]) {
                            const studentRef = db.doc(`artifacts/${appId}/public/data/students/${student.id}`);
                            batch.update(studentRef, { [`statuses.${id}`]: firebase.firestore.FieldValue.delete() });
                        }
                    });
                });
                await batch.commit();
                showNotification(`æˆåŠŸæ¸…é™¤äº† ${assignmentIdsToDelete.length} å€‹å·²å®Œæˆçš„ä½œæ¥­ï¼`);
            } catch (error) {
                console.error("æ¸…é™¤å·²å®Œæˆä½œæ¥­å¤±æ•—:", error);
                showNotification("æ¸…é™¤å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
            } finally {
                setIsDeleting(false);
                setIsClearCompletedModalOpen(false);
            }
        };
        
        const renderModalTitle = () => {
            const titleMap = { class: 'ç­ç´š', student: 'å­¸ç”Ÿ', assignment: 'ä½œæ¥­' };
            if (!modal.type) return '';
            if (modal.type === 'student' && !modal.data) return 'æ‰¹æ¬¡æ–°å¢å­¸ç”Ÿ';
            return `${modal.data ? 'ç·¨è¼¯' : 'æ–°å¢'}${titleMap[modal.type]}`;
        };

        const handleDragStart = (e, id) => {
            setDraggedAssignmentId(id);
            e.dataTransfer.effectAllowed = "move";
            e.dataTransfer.setData("text/plain", id);
        };

        const handleDragOver = (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = "move";
        };

        const handleDrop = async (e, targetId) => {
            e.preventDefault();
            if (!db) return;
            const sourceId = draggedAssignmentId;
            setDraggedAssignmentId(null);
            if (!sourceId || sourceId === targetId) return;
            const reorderedAssignments = [...sortedAssignments];
            const sourceIndex = reorderedAssignments.findIndex(a => a.id === sourceId);
            const targetIndex = reorderedAssignments.findIndex(a => a.id === targetId);
            if (sourceIndex === -1 || targetIndex === -1) return;
            const [movedAssignment] = reorderedAssignments.splice(sourceIndex, 1);
            reorderedAssignments.splice(targetIndex, 0, movedAssignment);
            const batch = db.batch();
            const ref = db.collection(`artifacts/${appId}/public/data/assignments`);
            reorderedAssignments.forEach((assignment, index) => {
                batch.update(ref.doc(assignment.id), { order: index });
            });
            try {
                await batch.commit();
                showNotification(`å·²æˆåŠŸæ›´æ–°ä½œæ¥­é †åºï¼`);
            } catch (error) {
                console.error("æ›´æ–°ä½œæ¥­é †åºå¤±æ•—:", error);
                showNotification("æ›´æ–°ä½œæ¥­é †åºå¤±æ•—ã€‚");
            }
        };

        const handleSignIn = async () => {
            setLoginError('');
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                await auth.signInWithPopup(provider);
            } catch (error) {
                console.error("Google ç™»å…¥å¤±æ•—:", error);
                if (error.code === 'auth/operation-not-supported-in-this-environment') {
                    setLoginError("Google ç™»å…¥ç„¡æ³•åœ¨ç›®å‰é è¦½ç’°å¢ƒä¸­ä½¿ç”¨ï¼Œè«‹åœ¨éƒ¨ç½²å¾Œçš„æ­£å¼ç¶²ç«™ä¸Šæ“ä½œã€‚");
                } else {
                    setLoginError(`ç™»å…¥å¤±æ•—: ${error.message}`);
                }
            }
        };

        const handleSignOut = async () => {
            try {
                await auth.signOut();
            } catch (error) {
                console.error("ç™»å‡ºå¤±æ•—:", error);
            }
        };
        
        const executeUpdateStatus = useCallback(async (student, assignment, newState) => {
            if (!db || isVisitorMode) return;
            const studentDocRef = db.doc(`artifacts/${appId}/public/data/students/${student.id}`);
            const storedState = student.statuses?.[assignment.id]?.state || 'default';
            let finalState = newState;
            if (!finalState) {
               switch (storedState) {
                    case 'default': finalState = 'submitted'; break;
                    case 'submitted': finalState = 'ignored'; break;
                    case 'ignored': finalState = 'default'; break;
                    default: finalState = 'default';
                }
            }
            let submittedDate = null;
            if (finalState === 'submitted' || finalState === 'late') {
                submittedDate = new Date().toISOString().substring(0, 10);
            }
            const newStatusObj = { state: finalState, submittedDate };
            await studentDocRef.update({ [`statuses.${assignment.id}`]: newStatusObj });
        }, [db, isVisitorMode]);
        
        const handleStatusChange = useCallback((student, assignment) => {
            if (isVisitorMode) return;
            const isPastDue = assignment.dueDate ? new Date(assignment.dueDate?.seconds ? assignment.dueDate.seconds * 1000 : assignment.dueDate).getTime() < now : false;
            if (isPastDue) {
                setStatusChangeModal({ isOpen: true, student, assignment });
            } else {
                executeUpdateStatus(student, assignment);
            }
        }, [now, executeUpdateStatus, isVisitorMode]);
        
        const handlePreciseStatusUpdate = async (newState) => {
            const { student, assignment } = statusChangeModal;
            if (!student || !assignment) return;
            const finalState = newState === 'unsubmitted' ? 'default' : newState;
            await executeUpdateStatus(student, assignment, finalState);
            setStatusChangeModal({ isOpen: false, student: null, assignment: null });
        };

        const handleCopyUnsubmitted = (assignmentId) => {
            const className = isVisitorMode ? (visitorData?.className || '') : activeClassName;
            const dataSet = isVisitorMode ? (visitorData?.assignments || []) : assignments;
            const studentSet = isVisitorMode ? (visitorData?.students || []) : students;

            const assignment = dataSet.find(a => a.id === assignmentId);
            if (!assignment) return;
            const unsubmittedStudents = studentSet.filter(s => getDisplayStatus(s, assignment) === 'unsubmitted').map(s => getSeatNumber(s.name));
            const d = new Date(assignment.dueDate?.seconds ? assignment.dueDate.seconds * 1000 : assignment.dueDate);
            const dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
            let text = `ã€${className}æœªç¹³ä½œæ¥­åå–®ã€‘\n`;
            text += `-${assignment.title}(${dateStr}æˆªæ­¢) :${unsubmittedStudents.length > 0 ? unsubmittedStudents.join(', ') : 'ç„¡'}`;
            copyToClipboard(text);
        };

        const handleCopyAllUnsubmitted = () => {
            const className = isVisitorMode ? (visitorData?.className || '') : activeClassName;
            const dataSet = isVisitorMode ? (visitorData?.assignments || []) : sortedAssignments;
            const studentSet = isVisitorMode ? (visitorData?.students || []) : students;

            let fullReport = `ã€${className}æœªç¹³ä½œæ¥­åå–®ã€‘\n`;
            let hasUnsubmitted = false;
            const unsubmittedAssignments = dataSet.filter(assignment => studentSet.some(s => getDisplayStatus(s, assignment) === 'unsubmitted'));
            
            const reportLines = [];
            unsubmittedAssignments.forEach((assignment) => {
                hasUnsubmitted = true;
                const unsubmittedStudents = studentSet.filter(s => getDisplayStatus(s, assignment) === 'unsubmitted').map(s => getSeatNumber(s.name));
                const d = new Date(assignment.dueDate?.seconds ? assignment.dueDate.seconds * 1000 : assignment.dueDate);
                const dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
                reportLines.push(`-${assignment.title}(${dateStr}æˆªæ­¢) :${unsubmittedStudents.join(', ')}`); 
            });

            if (hasUnsubmitted) {
                fullReport += reportLines.join('\n');
            } else {
                fullReport = `ã€${className}ã€‘å¤ªæ£’äº†ï¼æ‰€æœ‰é …ç›®éƒ½å·²ç¹³é½Šï¼`;
            }
            copyToClipboard(fullReport.trim());
        };

        // ğŸš€ ã€åŠŸèƒ½ 2ï¼šåŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (for åˆä½µåˆ—å°)ã€‘
        const handleExportMailMergeCSV = () => {
            const studentSet = isVisitorMode ? (visitorData?.students || []) : students;
            const dataSet = isVisitorMode ? (visitorData?.assignments || []) : sortedAssignments;

            if (!studentSet.length || !dataSet.length) {
                showNotification("æ²’æœ‰è³‡æ–™å¯åŒ¯å‡ºï¼");
                return;
            }

            const csvHeader = "åº§è™Ÿå§“å,æœªç¹³ä½œæ¥­æ¸…å–®\n";
            
            const csvRows = studentSet.map(student => {
                const unsubmittedList = dataSet
                    .filter(assignment => getDisplayStatus(student, assignment) === 'unsubmitted')
                    .map(assignment => assignment.title) // åªå–ä½œæ¥­æ¨™é¡Œ
                    .join('ã€'); // ä½¿ç”¨ã€Œã€ã€ç¬¦è™Ÿåˆ†éš”
                
                // ç¢ºä¿å§“åå’Œæ¸…å–®ä¸­çš„å¼•è™Ÿè¢«æ­£ç¢ºè·³è„«
                const studentName = (student.name || '').replace(/"/g, '""');
                const listText = unsubmittedList.replace(/"/g, '""');

                return `"${studentName}","${listText}"\n`;
            }).join('');

            const csvContent = csvHeader + csvRows;

            // å»ºç«‹ä¸¦è§¸ç™¼ä¸‹è¼‰ (åŠ ä¸Š BOM for Excel ä¸­æ–‡)
            const blob = new Blob([new Uint8Array([0xEF, 0xBB, 0xBF]), csvContent], { type: 'text/csv;charset=utf-8-sig;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            
            const className = isVisitorMode ? (visitorData?.className || 'ç­ç´š') : activeClassName;
            link.setAttribute('download', `${className}_å‚¬ç¹³ç¸½è¡¨.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showNotification("CSV å‚¬ç¹³ç¸½è¡¨å·²é–‹å§‹ä¸‹è¼‰ï¼");
        };

        const handleCopyStudentDefaulterList = (studentId) => {
            const studentSet = isVisitorMode ? (visitorData?.students || []) : students;
            const dataSet = isVisitorMode ? (visitorData?.assignments || []) : sortedAssignments;
            const student = studentSet.find(s => s.id === studentId);
            if (!student) return;
            const defaulterList = dataSet.filter(assignment => getDisplayStatus(student, assignment) === 'unsubmitted').map(assignment => {
                const d = new Date(assignment.dueDate?.seconds ? assignment.dueDate.seconds * 1000 : assignment.dueDate);
                const dateStr = `${d.getMonth() + 1}/${d.getDate()}`;
                return `${dateStr}-${assignment.title}`;
            }).join('ã€');
            const text = `ã€${student.name}ã€‘ç¼ºäº¤æ¸…å–®ï¼š\n${defaulterList || 'ç„¡'}`;
            copyToClipboard(text);
        };

        useEffect(() => {
            if (modal.type) {
                if (modal.data) {
                    let formData = {...modal.data};
                    if(modal.type === 'assignment' && formData.dueDate && (formData.dueDate.seconds || typeof formData.dueDate === 'string')) {
                        const d = new Date(formData.dueDate.seconds ? formData.dueDate.seconds * 1000 : formData.dueDate);
                        d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
                        formData.dueDate = d.toISOString().slice(0, 16);
                    }
                    setFormState(formData);
                } else {
                    const now = new Date();
                    now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                    const defaultState = {
                        class: { name: '', isPublic: false },
                        student: { name: '', studentList: '' },
                        assignment: { title: '', dueDate: now.toISOString().slice(0,16) }
                    };
                    setFormState(defaultState[modal.type]);
                }
            } else {
                setFormState({});
            }
        }, [modal]);

        const handleFormChange = (e) => {
           const { id, value, type, checked } = e.target;
           setFormState(prev => ({
             ...prev,
             [id]: type === 'checkbox' ? checked : value
           }));
        };
        
        if (loading.auth) {
            return <div className="flex items-center justify-center min-h-screen bg-gray-100"><p className="text-lg text-gray-600">æ­£åœ¨è¼‰å…¥...</p></div>;
        }
        
        if (isVisitorMode) {
            if (loading.data) {
                return <div className="flex items-center justify-center min-h-screen bg-gray-100"><p className="text-lg text-gray-600">æ­£åœ¨è¼‰å…¥å…¬é–‹é é¢...</p></div>;
            }
            if (visitorError) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-gray-100">
                        <div className="text-center p-8 bg-white rounded-2xl shadow-xl max-w-md w-full">
                            <h1 className="text-2xl font-bold text-red-600 mb-2">ç„¡æ³•è®€å–ä½œæ¥­ç¸½è¡¨</h1>
                            <p className="text-gray-600">{visitorError}</p>
                        </div>
                    </div>
                );
            }
            if (visitorData) {
                const { className, students, assignments, lastUpdated } = visitorData;
                const formattedDate = lastUpdated ? new Date(lastUpdated.seconds * 1000).toLocaleString('zh-TW', { hour12: false }) : 'N/A';
                
                const visitorSortedAssignments = [...(assignments || [])].sort((a, b) => {
                    const isPastDueA = a.dueDate ? new Date(a.dueDate?.seconds ? a.dueDate.seconds * 1000 : a.dueDate).getTime() < now : false;
                    const isCompleteA = isPastDueA && !(students || []).some(student => getDisplayStatus(student, a) === 'unsubmitted');
                    const isPastDueB = b.dueDate ? new Date(b.dueDate?.seconds ? b.dueDate.seconds * 1000 : b.dueDate).getTime() < now : false;
                    const isCompleteB = isPastDueB && !(students || []).some(student => getDisplayStatus(student, b) === 'unsubmitted');
                    
                    if (isCompleteA && !isCompleteB) return 1;
                    if (!isCompleteA && isCompleteB) return -1;
                    
                    return (a.order || 0) - (b.order || 0);
                });

                return (
                    <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                        <header className="bg-white rounded-xl shadow-lg p-6 mb-6">
                            <h1 className="text-3xl font-extrabold text-indigo-700">ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨</h1>
                            <p className="text-gray-600 mt-2">æ‚¨æ­£åœ¨ä»¥è¨ªå®¢æ¨¡å¼æª¢è¦– <span className="font-bold text-indigo-700">{className}</span> çš„ä½œæ¥­ç‹€æ³ (å”¯è®€)</p>
                            <p className="text-gray-600 mt-1">æœ€å¾Œæ›´æ–°æ–¼ï¼š{formattedDate}</p>
                               <div className="mt-4 border-t pt-3">
                                <div className="flex flex-wrap items-center gap-x-4 gap-y-2 text-gray-600">
                                    <span className="font-bold">åœ–ä¾‹:</span>
                                    <div className="flex items-center gap-1"><div className="w-4 h-4 rounded-full bg-green-500"></div><span>æº–æ™‚</span></div>
                                    <div className="flex items-center gap-1"><div className="w-4 h-4 rounded-full bg-yellow-500"></div><span>è£œäº¤</span></div>
                                    <div className="flex items-center gap-1"><div className="w-4 h-4 rounded-full bg-red-500"></div><span>é€¾æœŸ</span></div>
                                    <div className="flex items-center gap-1"><div className="w-4 h-4 rounded-full bg-white border-2 border-gray-400"></div><span>æœªæª¢</span></div>
                                    <div className="flex items-center gap-1"><div className="w-4 h-4 rounded-full bg-gray-500"></div><span>å¿½ç•¥</span></div>
                                </div>
                            </div>
                        </header>
                        <main>
                            <div className="flex justify-end gap-4 mb-2">
                                <Button onClick={() => handleCopyAllUnsubmitted()} className="bg-pink-500 hover:bg-pink-600">è¤‡è£½å…¨ç­æœªç¹³ç¸½è¡¨</Button>
                                <Button onClick={() => handleExportMailMergeCSV()} className="bg-green-600 hover:bg-green-700">åŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (CSV)</Button>
                            </div>
                            <AssignmentTable 
                                students={students || []} 
                                assignments={visitorSortedAssignments} 
                                getDisplayStatus={getDisplayStatus}
                                now={new Date().getTime()}
                                isVisitor={true}
                                getSeatNumber={getSeatNumber}
                            />
                        </main>
                    </div>
                )
            }
            return null;
        }

        if (!user) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-indigo-50">
                    <div className="text-center p-8 bg-white rounded-2xl shadow-xl max-w-md w-full">
                        <h1 className="text-3xl font-extrabold text-indigo-700 mb-2">ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨</h1>
                        <p className="text-gray-600 mb-6">ä¸€å€‹ç‚ºè€å¸«è¨­è¨ˆçš„é›²ç«¯åŒæ­¥å·¥å…·</p>
                        <button onClick={handleSignIn} className="w-full flex items-center justify-center gap-3 px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-indigo-600 hover:bg-indigo-700 transition duration-150">
                           <svg className="w-6 h-6" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.59,44,30.865,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                           ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                        </button>
                        {loginError && <p className="mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg">{loginError}</p>}
                    </div>
                </div>
            );
        }
        
        const activeClass = classes.find(c => c.id === activeClassId);
        const activeClassName = activeClass?.name || "ç­ç´š";

        return (
            <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                {notification && (<div className="fixed top-5 right-5 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg z-50 animate-bounce">{notification}</div>)}
                
                <Modal isOpen={isHelpModalOpen} title="æ“ä½œèªªæ˜" onClose={() => setIsHelpModalOpen(false)} footer={<Button onClick={() => setIsHelpModalOpen(false)}>é—œé–‰</Button>}>
                    <div className="space-y-3 text-gray-700">
                        <div>
                            <h3 className="font-bold mb-1 text-indigo-600">å–®å…ƒæ ¼é»æ“Šé †åº</h3>
                            <p className='font-mono'>æœªæª¢æŸ¥ âšªï¸ â†’ æº–æ™‚ç¹³äº¤ ğŸŸ¢ â†’ å¿½ç•¥æ­¤é … ğŸ”˜ â†’ æœªæª¢æŸ¥ âšªï¸</p>
                            <p className="text-sm mt-1 border-t pt-2">PS. ä½œæ¥­æˆªæ­¢å¾Œï¼Œæœªç¹³äº¤çš„ âšªï¸ æœƒè‡ªå‹•è®Šæˆé€¾æœŸæœªç¹³ ğŸ”´ã€‚æ­¤æ™‚é»é¸ä»»ä¸€ <b>å·²ç¢ºèª</b> æˆ– <b>é€¾æœŸ</b> çš„ç‹€æ…‹æœƒå½ˆå‡º<b>è©³ç´°é¸å–®</b> (å¯é¸: æº–æ™‚äº¤ / è£œäº¤ / é€¾æœŸæœªç¹³ / å¿½ç•¥æ­¤é …)ã€‚</p>
                        </div>
                        <div className="border-t pt-3">
                            <h3 className="font-bold mb-1 text-indigo-600">è¤‡è£½ã€åŒ¯å‡ºèˆ‡æ’åº</h3>
                            <ul className="space-y-1 text-sm list-decimal list-inside">
                                <li><b>[å–®ç§‘æœªç¹³åå–®]ï¼š</b>æ»‘é¼ ç§»åˆ°ç§‘ç›®åç¨±ï¼Œé»é¸å³ä¸Šè§’çš„å°åœ–ç¤ºè¤‡è£½æœªç¹³åå–®ï¼ˆåªé¡¯ç¤ºåº§è™Ÿï¼‰ã€‚</li>
                                <li><b>[å…¨ç­æœªç¹³ç¸½è¡¨]ï¼š</b>é»é¸ä¸Šæ–¹ç²‰è‰²æŒ‰éˆ•ï¼Œè¤‡è£½æ‰€æœ‰é€¾æœŸæœªç¹³é …ç›®çš„å½™ç¸½åå–®ã€‚</li>
                                <li><b>[å€‹äººä½œæ¥­æœªç¹³æ¸…å–®]ï¼š</b>æ»‘é¼ ç§»åˆ°è©²ç”Ÿçš„åº§è™Ÿå§“åï¼Œé»é¸å°åœ–ç¤ºè¤‡è£½è©²ç”Ÿç¼ºäº¤æ¸…å–®ï¼ˆé©åˆè¯ç¹«å®¶é•·ï¼‰ã€‚</li>
                                <li><b>[åŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (CSV)]ï¼š</b>é»é¸ä¸Šæ–¹ç¶ è‰²æŒ‰éˆ•ï¼ŒåŒ¯å‡ºå…¨ç­çš„å€‹äººæœªç¹³æ¸…å–® (é©åˆ Word åˆä½µåˆ—å°)ã€‚</li>
                                <li><b>[ä½œæ¥­æ’åº]ï¼š</b>ç›´æ¥æ‹–æ›³è¡¨æ ¼ä¸Šæ–¹çš„ä½œæ¥­æ¨™é¡Œå³å¯èª¿æ•´æ¬„ä½é †åºã€‚</li>
                            </ul>
                        </div>
                    </div>
                </Modal>
                
                <Modal isOpen={statusChangeModal.isOpen} title="æ›´æ”¹ç¹³äº¤ç‹€æ…‹" onClose={() => setStatusChangeModal({ isOpen: false, student: null, assignment: null })}>
                     <div className="text-center mb-4">
                       <p>å­¸ç”Ÿï¼š<span className="font-bold">{statusChangeModal.student?.name}</span></p>
                       <p>é …ç›®ï¼š<span className="font-bold">{statusChangeModal.assignment?.title}</span></p>
                     </div>
                    <div className="grid grid-cols-2 gap-3">
                       <Button onClick={() => handlePreciseStatusUpdate('submitted')} className="bg-green-500 hover:bg-green-600">ğŸŸ¢ æº–æ™‚ç¹³äº¤</Button>
                       <Button onClick={() => handlePreciseStatusUpdate('late')} className="bg-yellow-500 hover:bg-yellow-600">ğŸŸ¡ äº‹å¾Œè£œäº¤</Button>
                       <Button onClick={() => handlePreciseStatusUpdate('unsubmitted')} className="bg-red-500 hover:bg-red-600">ğŸ”´ é€¾æœŸæœªç¹³</Button>
                       <Button onClick={() => handlePreciseStatusUpdate('ignored')} className="bg-gray-400 hover:bg-gray-500">âšªï¸ å¿½ç•¥æ­¤é …</Button>
                    </div>
                </Modal>

                <Modal isOpen={!!modal.type} title={renderModalTitle()} onClose={() => setModal({ type: null, data: null })}
                    footer={<>
                        {modal.data && <Button onClick={handleDelete} disabled={isDeleting} className="bg-red-600 hover:bg-red-700 mr-auto">{isDeleting ? 'åˆªé™¤ä¸­...' : 'åˆªé™¤'}</Button>}
                        <Button onClick={() => setModal({ type: null, data: null })} className="bg-gray-500 hover:bg-gray-600">å–æ¶ˆ</Button>
                        <Button onClick={handleSave} disabled={isSaving}>{isSaving ? 'å„²å­˜ä¸­...' : 'å„²å­˜'}</Button>
                    </>}>
                    { modal.type === 'assignment' && <div className="space-y-4"><Input label="ä½œæ¥­/é …ç›®åç¨±" id="title" value={formState.title || ''} onChange={handleFormChange} /><Input label="æˆªæ­¢æ—¥æœŸèˆ‡æ™‚é–“" id="dueDate" type="datetime-local" value={formState.dueDate || ''} onChange={handleFormChange} /></div> }
                    
                    { modal.type === 'class' && (
                        <div className="space-y-6">
                            <Input label="ç­ç´šåç¨±" id="name" value={formState.name || ''} onChange={handleFormChange} />
                            <div className="relative">
                                <div className="absolute inset-0 flex items-center"><span className="w-full border-t"></span></div>
                                <div className="relative flex justify-center text-sm"><span className="px-2 bg-white text-gray-500">å…¬é–‹é€£çµè¨­å®š</span></div>
                            </div>
                            <div className="flex items-start space-x-3">
                                <input id="isPublic" type="checkbox" className="h-5 w-5 mt-0.5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500" checked={formState.isPublic || false} onChange={handleFormChange} />
                                <div className="flex-1">
                                    <label htmlFor="isPublic" className="block text-sm font-medium text-gray-800">å•Ÿç”¨æ­¤ç­ç´šçš„å…¬é–‹è¨ªå®¢é€£çµ</label>
                                    <p className="text-xs text-gray-500 mt-1">å•Ÿç”¨å¾Œï¼Œé‚„éœ€é»æ“Šã€Œæ›´æ–°å…¬é–‹é é¢ã€æŒ‰éˆ•ï¼Œè¨ªå®¢æ‰èƒ½çœ‹åˆ°æœ€æ–°è³‡æ–™ã€‚</p>
                                </div>
                            </div>
                            {formState.isPublic && modal.data?.id && (
                                <div className="space-y-2">
                                    <Input label="è¨ªå®¢å°ˆç”¨é€£çµ (å”¯è®€)" id="visitorLink" value={getVisitorLink(modal.data.id)} readOnly={true} onChange={()=>{}} />
                                    <Button onClick={() => copyToClipboard(getVisitorLink(modal.data.id))} className="w-full bg-green-600 hover:bg-green-700">è¤‡è£½é€£çµ</Button>
                                </div>
                            )}
                        </div>
                    )}
                    { modal.type === 'student' && (modal.data ? <Input label="å­¸ç”Ÿåº§è™Ÿ/å§“å" id="name" value={formState.name || ''} onChange={handleFormChange} /> : <Textarea label="å­¸ç”Ÿåå–® (ä¸€è¡Œä¸€å€‹)" id="studentList" value={formState.studentList || ''} onChange={handleFormChange} placeholder="å¾ Excel æˆ–æ–‡ä»¶è¤‡è£½åå–®è²¼åˆ°é€™è£¡ï¼Œä¾‹å¦‚ï¼š&#10;1è™Ÿ ç‹å°æ˜&#10;2è™Ÿ é™³å¤§è¯&#10;3è™Ÿ æç¾éº—" />) }
                </Modal>
                
                <Modal isOpen={isClearCompletedModalOpen} title="âš ï¸ ç¢ºèªæ¸…é™¤å·²å®Œæˆä½œæ¥­" onClose={() => setIsClearCompletedModalOpen(false)} footer={<>
                        <Button onClick={() => setIsClearCompletedModalOpen(false)} className="bg-gray-500 hover:bg-gray-600">å–æ¶ˆ</Button>
                        <Button onClick={handleClearCompletedAssignments} disabled={isDeleting} className="bg-red-600 hover:bg-red-700">{isDeleting ? 'åˆªé™¤ä¸­...' : 'ç¢ºèªåˆªé™¤'}</Button>
                    </>}>
                    <div className="text-sm text-gray-700">
                        <p className="font-bold mb-2">æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ä»¥ä¸‹ {completedAssignments.length} å€‹å·²å®Œæˆçš„ä½œæ¥­é …ç›®å—ï¼Ÿ</p>
                        <ul className="list-disc list-inside bg-gray-50 p-2 rounded max-h-32 overflow-y-auto">
                            {completedAssignments.map(a => <li key={a.id}>{a.title}</li>)}
                        </ul>
                        <p className="mt-4 text-red-600 font-semibold">æ­¤æ“ä½œå°‡æœƒç§»é™¤é€™äº›ä½œæ¥­çš„æ‰€æœ‰ç›¸é—œç´€éŒ„ï¼Œä¸”ç„¡æ³•å¾©åŸã€‚</p>
                    </div>
                </Modal>

                <header className="bg-white rounded-xl shadow-lg p-6 mb-6">
                    <div className="flex flex-wrap justify-between items-center gap-4">
                        <div className="flex items-center gap-4">
                            <h1 className="text-3xl font-extrabold text-indigo-700">ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨</h1>
                            <button onClick={() => setIsHelpModalOpen(true)} className="text-sm text-indigo-600 hover:underline pt-2">æ“ä½œèªªæ˜</button>
                        </div>
                        <div className="flex items-center gap-3">
                            <span className="text-sm text-gray-600">æ­¡è¿, {user.displayName || user.email}</span>
                            <button onClick={handleSignOut} className="text-sm text-red-500 hover:underline">ç™»å‡º</button>
                        </div>
                    </div>
                    <div className="text-sm text-gray-600 mt-2 space-y-1">
                        <p>1. è¿½è¹¤<b>å¤šç­ç´š</b>åŠ<b>å¤šç§‘ç›®</b>ä½œæ¥­ç¹³äº¤ç‹€æ³ï¼Œè³‡æ–™å„²å­˜æ–¼é›²ç«¯ã€‚</p>
                        <p>2. å¯ç”¢å‡º<b>å–®ç§‘æœªç¹³åå–®</b>ã€<b>å…¨ç­æœªç¹³ç¸½è¡¨</b>ã€<b>å€‹äººä½œæ¥­æœªç¹³æ¸…å–®</b>ã€‚</p>
                    </div>
                    <div className="mt-4 border-t pt-4">
                        <div className="flex flex-wrap items-center gap-2">
                            {classes.map(c => (<button key={c.id} onClick={() => setActiveClassId(c.id)} className={`px-4 py-2 rounded-lg text-sm font-semibold transition ${activeClassId === c.id ? 'bg-indigo-600 text-white shadow' : 'bg-gray-200 text-gray-700 hover:bg-gray-300'}`}>{c.name}</button>))}
                            <button onClick={() => setModal({ type: 'class', data: null })} className="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 shadow text-sm font-semibold">æ–°å¢ç­ç´š</button>
                             {activeClassId && <button onClick={() => setModal({ type: 'class', data: classes.find(c=> c.id === activeClassId) })} className="px-3 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 text-xs">ç·¨è¼¯ç­ç´š</button>}
                             
                             {activeClass?.isPublic && (
                                <Button 
                                    onClick={handlePublishPublicData} 
                                    disabled={loading.publishing}
                                    className="bg-teal-500 hover:bg-teal-600"
                                    title="å°‡ç›®å‰æœ€æ–°çš„ä½œæ¥­ç‹€æ³ï¼Œç™¼å¸ƒåˆ°å…¬é–‹çš„è¨ªå®¢é€£çµé é¢"
                                >
                                    {loading.publishing ? 'ç™¼å¸ƒä¸­...' : 'æ›´æ–°å…¬é–‹é é¢'}
                                </Button>
                             )}
                        </div>
                    </div>
                </header>
                
                {loading.classes ? <p className="text-center p-4">æ­£åœ¨è¼‰å…¥ç­ç´šåˆ—è¡¨...</p> : !activeClassId && user ? (
                     <div className="p-10 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center text-gray-500">
                       <p className="text-xl font-medium mb-2">{classes.length === 0 ? "æ­¡è¿ä½¿ç”¨ï¼" : "è«‹é¸æ“‡ä¸€å€‹ç­ç´šä»¥é–‹å§‹"}</p>
                       <p>{classes.length === 0 ? "è«‹é»æ“Šã€Œæ–°å¢ç­ç´šã€æŒ‰éˆ•ï¼Œå»ºç«‹æ‚¨çš„ç¬¬ä¸€å€‹ç­ç´šã€‚" : ""}</p>
                     </div>
                ) : (
                    <main>
                        <div className="flex flex-wrap justify-between items-center gap-x-4 gap-y-2 mb-2">
                             <h2 className="text-2xl font-bold text-gray-800">{activeClassName}</h2>
                             <div className="flex flex-wrap items-center gap-4">
                               <Button onClick={() => setModal({ type: 'assignment', data: null })} className="bg-purple-500 hover:bg-purple-600">ï¼‹ æ–°å¢ä½œæ¥­</Button>
                               <Button onClick={handleCopyAllUnsubmitted} className="bg-pink-500 hover:bg-pink-600">è¤‡è£½å…¨ç­æœªç¹³ç¸½è¡¨</Button>
                               {/* ğŸš€ã€åŠŸèƒ½ 2ï¼šåŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ã€‘æŒ‰éˆ•å·²æ–°å¢ */}
                               <Button onClick={handleExportMailMergeCSV} className="bg-green-600 hover:bg-green-700">åŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (CSV)</Button>
                               <Button 
                                 onClick={() => setIsClearCompletedModalOpen(true)} 
                                 disabled={completedAssignments.length === 0} 
                                 className="bg-red-600 hover:bg-red-700"
                                 title={completedAssignments.length === 0 ? "ç›®å‰æ²’æœ‰å·²å®Œæˆçš„ä½œæ¥­å¯æ¸…é™¤" : "æ¸…é™¤æ‰€æœ‰å·²å®Œæˆçš„ä½œæ¥­"}
                               >
                                 æ¸…é™¤å·²å®Œæˆä½œæ¥­ ({completedAssignments.length})
                               </Button>
                             </div>
                        </div>
                        {loading.data ? <p className="text-center p-4">æ­£åœ¨è¼‰å…¥ {activeClassName} çš„è³‡æ–™...</p> : (
                            <>
                                <AssignmentTable 
                                  students={students} 
                                  assignments={sortedAssignments} 
                                  onStatusChange={handleStatusChange} 
                                  getDisplayStatus={getDisplayStatus} 
                                  onEditStudent={(student) => setModal({ type: 'student', data: student })} 
                                  onEditAssignment={(assignment) => setModal({ type: 'assignment', data: assignment })} 
                                  onCopyUnsubmitted={handleCopyUnsubmitted} 
                                  onCopyStudentDefaulterList={handleCopyStudentDefaulterList}
                                  handleDragStart={handleDragStart}
                                  handleDragOver={handleDragOver}
                                  handleDrop={handleDrop}
                                  draggedAssignmentId={draggedAssignmentId}
                                  now={now}
                                  getSeatNumber={getSeatNumber}
                                />
                                 <div className="mt-4 flex gap-4">
                                  <Button onClick={() => setModal({ type: 'student', data: null })} className="bg-blue-500 hover:bg-blue-600">ï¼‹ æ‰¹æ¬¡æ–°å¢å­¸ç”Ÿ</Button>
                                 </div>
                            </>
                        )}
                    </main>
                )}
            </div>
        );
    }
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
</body>
</html>
