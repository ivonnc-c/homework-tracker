<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨ v2.0</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
    const { useState, useEffect, useCallback, useMemo } = React;

    // =======================================================================
    // â­ï¸â­ï¸â­ï¸ã€ ä½¿ç”¨è€…è¨­å®šå€å¡Š ã€‘â­ï¸â­ï¸â­ï¸
    // è«‹å°‡ä¸‹æ–¹ firebaseConfig ç‰©ä»¶çš„å…§å®¹ï¼Œæ›¿æ›æˆæ‚¨è‡ªå·±åœ¨ Firebase å°ˆæ¡ˆä¸­å–å¾—çš„è¨­å®šã€‚
    // =======================================================================
   const firebaseConfig = {
     apiKey: "AIzaSyACc1hEmcC7GR84_jvtYb2rG5bfErCenCc",
     authDomain: "homeworktracker-32647.firebaseapp.com",
     projectId: "homeworktracker-32647",
     storageBucket: "homeworktracker-32647.firebasestorage.app",
     messagingSenderId: "614728738497",
     appId: "1:614728738497:web:222fcb82c471e7095b5640"
   };
    // =======================================================================
    // â­ï¸â­ï¸â­ï¸ã€ è¨­å®šå€å¡ŠçµæŸ ã€‘â­ï¸â­ï¸â­ï¸
    // =======================================================================

    const getVisitorLink = (classId) => {
      if (!classId) return '';
      return `${window.location.origin}${window.location.pathname}?classId=${classId}`;
    };
    
    const appId = 'super-tracker-default';

    const STATUS_MAP = {
        'default':     { color: 'bg-white border-2 border-gray-400', name: 'å°šæœªæª¢æŸ¥' },
        'submitted':   { color: 'bg-green-500', name: 'æº–æ™‚ç¹³äº¤' },
        'late':        { color: 'bg-yellow-500', name: 'äº‹å¾Œè£œäº¤' },
        'unsubmitted': { color: 'bg-red-500', name: 'é€¾æœŸæœªç¹³' },
        'ignored':     { color: 'bg-gray-500', name: 'å¿½ç•¥' },
    };

    const Modal = ({ isOpen, title, children, onClose, footer }) => {
        if (!isOpen) return null;
        return (
            <div className="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 p-4" onClick={onClose}>
                <div className="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md transform transition-all duration-300" onClick={(e) => e.stopPropagation()}>
                    <h2 className="text-xl font-bold mb-4 text-indigo-700 border-b pb-2">{title}</h2>
                    <div className="mb-6">{children}</div>
                    {footer && <div className="flex justify-end space-x-3">{footer}</div>}
                </div>
            </div>
        );
    };
    
    const Input = ({ label, id, value, onChange, type = "text", required = false, readOnly = false }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <input id={id} type={type} value={value} onChange={onChange} required={required} readOnly={readOnly} className={`w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 ${readOnly ? 'bg-gray-100 cursor-not-allowed' : ''}`} />
        </div>
    );

    const Textarea = ({ label, id, value, onChange, placeholder, rows = 8 }) => (
        <div>
            {label && <label htmlFor={id} className="block text-sm font-medium text-gray-700 mb-1">{label}</label>}
            <textarea id={id} value={value} onChange={onChange} placeholder={placeholder} rows={rows} className="w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" />
        </div>
    );

    const Button = ({ children, onClick, disabled = false, className = "bg-indigo-600 hover:bg-indigo-700", type = "button" }) => (
        <button onClick={onClick} disabled={disabled} type={type} className={`flex justify-center items-center px-6 py-2 border border-transparent text-sm font-medium rounded-lg shadow-sm text-white ${className} disabled:opacity-50 disabled:cursor-not-allowed transition duration-150`}>
            {children}
        </button>
    );

    const StatusCell = ({ status, onClick, isVisitor = false }) => {
        const currentStatus = STATUS_MAP[status] || STATUS_MAP.default;
        const buttonClasses = `w-6 h-6 rounded-full shadow-md mx-auto block ${currentStatus.color}`;
        if (isVisitor) {
            return <td className="border p-1 text-center"><div className={buttonClasses} title={currentStatus.name} /></td>;
        }
        return <td className="border p-1 text-center"><button onClick={onClick} className={`${buttonClasses} transform transition duration-150 active:scale-95`} title={currentStatus.name}/></td>;
    };
    
    const AssignmentHeader = ({ assignment, onEdit, onCopy, onDragStart, onDragOver, onDrop, isDragging, isComplete, isVisitor = false }) => {
        const formatDate = (dateString) => {
            if (!dateString) return '';
            const d = new Date(dateString);
            return `${d.getMonth()+1}/${String(d.getDate()).padStart(2,'0')} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
        };
        
        const dragStyles = isDragging ? 'opacity-50 border-4 border-indigo-400' : 'opacity-100 border-2 border-transparent';
        const completeStyle = isComplete ? 'bg-green-200' : 'bg-gray-100';
        const cursorStyle = isVisitor ? 'cursor-default' : 'cursor-grab';
        const widthStyle = 'w-24';

        return (
            <th 
                className={`border p-1 text-center text-sm font-semibold text-gray-700 bg-gray-100 ${widthStyle} ${cursorStyle} ${dragStyles} ${completeStyle}`}
                draggable={!isVisitor}
                onDragStart={onDragStart}
                onDragOver={onDragOver}
                onDrop={onDrop}
                data-assignment-id={assignment.id}
            >
                <div className="group relative">
                    <div className={isVisitor ? '' : 'cursor-pointer'} onClick={isVisitor ? null : onEdit}>
                        <p className="font-bold">{assignment.title}</p>
                        <p className="text-xs text-red-500">[{formatDate(assignment.dueDate)}]</p>
                        {isComplete && <p className="text-xs text-green-700 font-bold">[å·²å®Œæˆ]</p>}
                    </div>
                    {!isVisitor && (
                        <button onClick={onCopy} className="absolute -top-1 -right-1 opacity-0 group-hover:opacity-100 transition-opacity bg-pink-500 text-white rounded-full p-1 shadow-lg hover:bg-pink-600" title={`è¤‡è£½ã€Œ${assignment.title}ã€çš„æœªç¹³åå–®`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-6 4H9m-1 0h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    // ğŸš€ã€åŠŸèƒ½ 3ï¼šç´…ç‡ˆæç¤ºã€‘ä¿®æ”¹ StudentCellï¼Œå¢åŠ  hasUnsubmitted prop
    const StudentCell = ({ student, onEdit, onCopyDefaulterList, isVisitor = false, getSeatNumber, hasUnsubmitted }) => {
        // æ±ºå®šåº•è‰²ï¼šå¦‚æœ hasUnsubmitted ç‚º trueï¼Œä½¿ç”¨æ·¡ç´…è‰²
        const baseBg = 'bg-gray-50';
        const warningBg = hasUnsubmitted ? 'bg-red-100' : baseBg;

        return (
            <th className={`border p-1 text-sm text-center font-semibold text-gray-800 sticky left-0 z-10 ${isVisitor ? 'w-16' : 'w-32'} ${warningBg}`}>
                <div className="flex items-center justify-between group px-2">
                    <span className={isVisitor ? '' : 'cursor-pointer hover:underline'} onClick={isVisitor ? null : onEdit}>
                        {isVisitor ? getSeatNumber(student.name) : student.name}
                    </span>
                    {!isVisitor && (
                        <button onClick={onCopyDefaulterList} className="opacity-0 group-hover:opacity-100 transition-opacity text-blue-500 hover:text-blue-700 p-1" title={`${student.name} çš„ç¼ºäº¤æ¸…å–®`}>
                            <svg xmlns="http://www.w3.org/2000/svg" className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002 2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                        </button>
                    )}
                </div>
            </th>
        );
    };

    const AssignmentTable = ({ students, assignments, onStatusChange, getDisplayStatus, onEditStudent, onEditAssignment, onCopyUnsubmitted, onCopyStudentDefaulterList, handleDragStart, handleDragOver, handleDrop, draggedAssignmentId, now, isVisitor = false, getSeatNumber }) => {
        const headerWidthClass = isVisitor ? 'w-16' : 'w-32';
        if (!students || students.length === 0 && (!assignments || assignments.length === 0)) return <div className="p-10 bg-white rounded-xl shadow-lg border-2 border-dashed border-gray-300 text-center text-gray-500 mt-4"><p className="text-xl font-medium mb-2">æ­¤ç­ç´šå°šç„¡å­¸ç”Ÿæˆ–ä½œæ¥­é …ç›®</p></div>;
        return (
            <div className="overflow-x-auto bg-white rounded-xl shadow-lg mt-4">
                <table className="border-collapse table-fixed w-full">
                    <thead>
                        <tr>
                            <th className={`border p-1 text-center font-semibold text-gray-700 bg-gray-100 sticky left-0 z-20 ${headerWidthClass}`}>å­¸ç”Ÿåº§è™Ÿ</th>
                            {assignments.map(assignment => {
                                const isPastDue = assignment.dueDate ? new Date(assignment.dueDate).getTime() < now : false;
                                const isComplete = isPastDue && !students.some(student => getDisplayStatus(student, assignment) === 'unsubmitted');
                                return (
                                    <AssignmentHeader 
                                        key={assignment.id} 
                                        assignment={assignment} 
                                        onEdit={() => onEditAssignment(assignment)} 
                                        onCopy={() => onCopyUnsubmitted(assignment.id)}
                                        onDragStart={(e) => handleDragStart(e, assignment.id)}
                                        onDragOver={handleDragOver}
                                        onDrop={(e) => handleDrop(e, assignment.id)}
                                        isDragging={draggedAssignmentId === assignment.id}
                                        isComplete={isComplete}
                                        isVisitor={isVisitor}
                                    />
                                );
                            })}
                        </tr>
                    </thead>
                    <tbody>
                        {students.map((student, index) => {
                            // ğŸš€ã€åŠŸèƒ½ 3ï¼šç´…ç‡ˆæç¤ºã€‘åœ¨é€™è£¡è¨ˆç®—è©²ç”Ÿæ˜¯å¦æœ‰æœªç¹³
                            const hasUnsubmitted = !isVisitor && assignments.some(assignment => getDisplayStatus(student, assignment) === 'unsubmitted');
                            
                            return (
                                <tr key={student.id} className={index % 2 === 0 ? 'bg-white' : 'bg-slate-50'}>
                                    <StudentCell 
                                        student={student} 
                                        onEdit={() => onEditStudent(student)} 
                                        onCopyDefaulterList={() => onCopyStudentDefaulterList(student.id)} 
                                        isVisitor={isVisitor} 
                                        getSeatNumber={getSeatNumber}
                                        hasUnsubmitted={hasUnsubmitted} 
                                    />
                                    {assignments.map(assignment => <StatusCell key={assignment.id} status={getDisplayStatus(student, assignment)} onClick={() => onStatusChange(student, assignment)} isVisitor={isVisitor}/>)}
                                </tr>
                            );
                        })}
                    </tbody>
                </table>
            </div>
        );
    };
    
function App() {
        // --- State Variables ---
        const [db, setDb] = useState(null);
        const [auth, setAuth] = useState(null);
        const [user, setUser] = useState(null);

        const [visitorData, setVisitorData] = useState(null);
        const [isVisitorMode, setIsVisitorMode] = useState(false);
        const [visitorError, setVisitorError] = useState(null);

        const [loginError, setLoginError] = useState('');
        const [classes, setClasses] = useState([]);
        const [activeClassId, setActiveClassId] = useState(null);
        const [students, setStudents] = useState([]);
        const [assignments, setAssignments] = useState([]);
        const [loading, setLoading] = useState({ auth: true, classes: false, data: false, publishing: false });
        const [now, setNow] = useState(new Date().getTime());
        const [modal, setModal] = useState({ type: null, data: null });
        const [statusChangeModal, setStatusChangeModal] = useState({ isOpen: false, student: null, assignment: null });
        const [isHelpModalOpen, setIsHelpModalOpen] = useState(false);
        const [isClearCompletedModalOpen, setIsClearCompletedModalOpen] = useState(false);
        const [isSaving, setIsSaving] = useState(false);
        const [isDeleting, setIsDeleting] = useState(false);
        const [formState, setFormState] = useState({});
        const [notification, setNotification] = useState('');
        const [draggedAssignmentId, setDraggedAssignmentId] = useState(null);

        // âœ¨ æ–°å¢ï¼šç”¨æ–¼ Email/å¯†ç¢¼ ç™»å…¥/è¨»å†Šçš„ç‹€æ…‹ (ç§»åˆ°é ‚å±¤)âœ¨
        const [email, setEmail] = useState('');
        const [password, setPassword] = useState('');
        const [isRegistering, setIsRegistering] = useState(false); // æ§åˆ¶é¡¯ç¤ºç™»å…¥æˆ–è¨»å†Šè¡¨å–®

        // --- Effects ---
        useEffect(() => {
            const timer = setInterval(() => setNow(new Date().getTime()), 60000);
            return () => clearInterval(timer);
        }, []);

        useEffect(() => {
            // Firebase åˆå§‹åŒ–ã€Persistenceã€Redirect Result æª¢æŸ¥ã€Auth ç‹€æ…‹ç›£è½
            const params = new URLSearchParams(window.location.search);
            const classIdFromUrl = params.get('classId');

            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const authInstance = firebase.auth();
            const firestoreInstance = firebase.firestore();

            firestoreInstance.enablePersistence()
              .then(() => console.log("Firebase é›¢ç·šæ¨¡å¼å·²å•Ÿç”¨."))
              .catch((err) => { /* ...çœç•¥éŒ¯èª¤è™•ç†... */ });

            setAuth(authInstance);
            setDb(firestoreInstance);
            firebase.firestore.setLogLevel('error');

            // è¨­å®š Persistence ä¸¦æª¢æŸ¥ Redirect Result
            authInstance.setPersistence(firebase.auth.Auth.Persistence.LOCAL)
                .then(() => {
                    console.log("Auth persistence set to LOCAL.");
                    console.log("é é¢è¼‰å…¥ï¼šé–‹å§‹æª¢æŸ¥ getRedirectResult...");
                    return authInstance.getRedirectResult();
                })
                .then((result) => {
                    console.log("getRedirectResult .then() - result:", result);
                    if (result && result.user) {
                       console.log("ç™»å…¥æˆåŠŸ (ä¾†è‡ª Redirect):", result.user.uid);
                    } else {
                       console.log("getRedirectResult .then() - æ²’æœ‰åµæ¸¬åˆ° user ç‰©ä»¶ã€‚");
                    }
                })
                .catch((error) => {
                    console.error("è¨­å®š Persistence æˆ– getRedirectResult å‡ºéŒ¯:", error);
                    // ...çœç•¥éŒ¯èª¤è™•ç†...
                     setLoginError(`ç™»å…¥å¤±æ•—: ${error.message}`); // ç°¡åŒ–éŒ¯èª¤æç¤º
                });

            // æ ¹æ“š URL åˆ¤æ–·æ¨¡å¼ æˆ– è¨­å®š Auth ç‹€æ…‹ç›£è½
            if (classIdFromUrl) {
                setIsVisitorMode(true);
                setLoading(p => ({...p, auth: false, data: true}));
                // ... çœç•¥è¨ªå®¢è³‡æ–™è®€å–é‚è¼¯ ...
                 const publicDocRef = firestoreInstance.doc(`artifacts/${appId}/publicData/${classIdFromUrl}`);
                 publicDocRef.get().then(doc => {
                     if (doc.exists) { setVisitorData(doc.data()); }
                     else { setVisitorError('æ­¤ç­ç´šçš„å…¬é–‹é é¢ä¸å­˜åœ¨æˆ–å°šæœªç™¼å¸ƒã€‚'); }
                 }).catch(err => {
                     console.error("è®€å–å…¬é–‹è³‡æ–™å¤±æ•—:", err);
                     setVisitorError('è®€å–è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚');
                 }).finally(() => { setLoading(p => ({...p, data: false})); });
            } else {
                console.log("é é¢è¼‰å…¥ï¼šé–‹å§‹è¨­å®š onAuthStateChanged ç›£è½å™¨...");
                const unsub = authInstance.onAuthStateChanged((user) => {
                    console.log("onAuthStateChanged è§¸ç™¼ - user:", user ? user.uid : null);
                    setUser(user);
                    // ç™»å…¥æˆåŠŸå¾Œæ¸…é™¤ loginError
                    if (user) setLoginError('');
                    setLoading(prev => ({ ...prev, auth: false }));
                });
                return () => unsub();
            }
        }, []); // ä¿æŒä¾è³´é …ç‚ºç©º

        // --- Data Fetching Effects (ç­ç´š, å­¸ç”Ÿ, ä½œæ¥­) ---
        // (é€™å…©å€‹ useEffect ä¿æŒä¸è®Šï¼Œçœç•¥...)
        useEffect(() => { /* ... ç­ç´šè³‡æ–™ç›£è½ ... */ }, [user, db, isVisitorMode]);
        useEffect(() => { /* ... å­¸ç”ŸåŠä½œæ¥­è³‡æ–™ç›£è½ ... */ }, [user, activeClassId, db, isVisitorMode]);


        // --- Helper Functions & Callbacks ---
        const getDisplayStatus = useCallback((student, assignment) => { /* ...çœç•¥... */ }, [now]);
        const showNotification = (message) => { /* ...çœç•¥... */ };
        const copyToClipboard = (text) => { /* ...çœç•¥... */ };
        const getSeatNumber = (name) => { /* ...çœç•¥... */ };
        const handlePublishPublicData = async () => { /* ...çœç•¥... */ };
        const handleSave = async () => { /* ...çœç•¥... */ };
        const handleDelete = async () => { /* ...çœç•¥... */ };
        const handleClearCompletedAssignments = async () => { /* ...çœç•¥... */ };
        const renderModalTitle = () => { /* ...çœç•¥... */ };
        const handleDragStart = (e, id) => { /* ...çœç•¥... */ };
        const handleDragOver = (e) => { /* ...çœç•¥... */ };
        const handleDrop = async (e, targetId) => { /* ...çœç•¥... */ };
        const handleSignOut = async () => { /* ...çœç•¥... */ };
        const executeUpdateStatus = useCallback(async (student, assignment, newState) => { /* ...çœç•¥... */ }, [db, isVisitorMode]);
        const handleStatusChange = useCallback((student, assignment) => { /* ...çœç•¥... */ }, [now, executeUpdateStatus, isVisitorMode]);
        const handlePreciseStatusUpdate = async (newState) => { /* ...çœç•¥... */ };
        const handleCopyUnsubmitted = (assignmentId) => { /* ...çœç•¥... */ };
        const handleCopyAllUnsubmitted = () => { /* ...çœç•¥... */ };
        const handleExportMailMergeCSV = () => { /* ...çœç•¥... */ };
        const handleCopyStudentDefaulterList = (studentId) => { /* ...çœç•¥... */ };
        const handleFormChange = (e) => { /* ...çœç•¥... */ };

        // âœ¨ æ–°å¢ï¼šè™•ç† Email/å¯†ç¢¼ ç™»å…¥çš„å‡½å¼ (ç§»åˆ°é ‚å±¤)âœ¨
        const handleEmailSignIn = async (e) => {
          e.preventDefault();
          setLoginError('');
          setIsSaving(true); // é–‹å§‹è™•ç†
          console.log("å˜—è©¦ Email ç™»å…¥:", email);
          try {
              if (!auth) throw new Error("é©—è­‰æ¨¡çµ„å°šæœªåˆå§‹åŒ–");
              await auth.signInWithEmailAndPassword(email, password);
              // ç™»å…¥æˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•è§¸ç™¼ä¸¦æ›´æ–° user ç‹€æ…‹
              console.log("Email ç™»å…¥è«‹æ±‚æˆåŠŸ");
          } catch (error) {
              console.error("Email ç™»å…¥å¤±æ•—:", error);
              // æ ¹æ“šéŒ¯èª¤ç¢¼æä¾›æ›´å‹å–„çš„æç¤º
              if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
                   setLoginError('é›»å­éƒµä»¶æˆ–å¯†ç¢¼éŒ¯èª¤ã€‚');
              } else if (error.code === 'auth/invalid-email') {
                   setLoginError('é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚');
              } else {
                   setLoginError(`ç™»å…¥å¤±æ•—ï¼š${error.message}`);
              }
          } finally {
              setIsSaving(false); // çµæŸè™•ç†
          }
        };

        // âœ¨ æ–°å¢ï¼šè™•ç† Email/å¯†ç¢¼ è¨»å†Šçš„å‡½å¼ (ç§»åˆ°é ‚å±¤)âœ¨
        const handleEmailSignUp = async (e) => {
          e.preventDefault();
          setLoginError('');
          setIsSaving(true); // é–‹å§‹è™•ç†
          console.log("å˜—è©¦ Email è¨»å†Š:", email);
           try {
              if (!auth) throw new Error("é©—è­‰æ¨¡çµ„å°šæœªåˆå§‹åŒ–");
              await auth.createUserWithEmailAndPassword(email, password);
              // è¨»å†ŠæˆåŠŸå¾Œï¼ŒonAuthStateChanged æœƒè‡ªå‹•è§¸ç™¼ä¸¦æ›´æ–° user ç‹€æ…‹
              console.log("Email è¨»å†ŠæˆåŠŸ");
              // å¯é¸ï¼šè¨»å†ŠæˆåŠŸå¾Œæ¸…ç©ºè¡¨å–®
              // setEmail('');
              // setPassword('');
              // setIsRegistering(false); // åˆ‡å›ç™»å…¥æ¨¡å¼
          } catch (error) {
              console.error("Email è¨»å†Šå¤±æ•—:", error);
              if (error.code === 'auth/email-already-in-use') {
                  setLoginError('æ­¤é›»å­éƒµä»¶å·²è¢«è¨»å†Šã€‚');
              } else if (error.code === 'auth/weak-password') {
                  setLoginError('å¯†ç¢¼å¼·åº¦ä¸è¶³ï¼Œè«‹è¨­å®šè‡³å°‘å…­ä½æ•¸çš„å¯†ç¢¼ã€‚');
              } else if (error.code === 'auth/invalid-email') {
                   setLoginError('é›»å­éƒµä»¶æ ¼å¼ä¸æ­£ç¢ºã€‚');
              } else {
                  setLoginError(`è¨»å†Šå¤±æ•—ï¼š${error.message}`);
              }
          } finally {
              setIsSaving(false); // çµæŸè™•ç†
          }
        };

        // âœ¨ Google ç™»å…¥å‡½å¼ (ä¿æŒ Redirect) âœ¨
        const handleSignIn = async () => {
            setLoginError('');
            const provider = new firebase.auth.GoogleAuthProvider();
            try {
                if (!auth) throw new Error("é©—è­‰æ¨¡çµ„å°šæœªåˆå§‹åŒ–");
                await auth.signInWithRedirect(provider);
            } catch (error) {
                console.error("Google ç™»å…¥é‡æ–°å°å‘å•Ÿå‹•å¤±æ•—:", error);
                setLoginError(`å•Ÿå‹• Google ç™»å…¥æµç¨‹å¤±æ•—: ${error.message}`);
            }
        };

        // --- Memoized Values ---
        const sortedAssignments = useMemo(() => { /* ...çœç•¥... */ }, [assignments, students, now, getDisplayStatus]);
        const completedAssignments = useMemo(() => { /* ...çœç•¥... */ }, [sortedAssignments, students, now, getDisplayStatus]);


        // --- Render Logic ---
        if (loading.auth) {
            return <div className="flex items-center justify-center min-h-screen bg-gray-100"><p className="text-lg text-gray-600">æ­£åœ¨é©—è­‰æ‚¨çš„èº«åˆ†...</p></div>;
        }

        // ğŸŒŸ é‡æ–°æ•´ç†å¾Œçš„æ¸²æŸ“é‚è¼¯ ğŸŒŸ
        // 1. å„ªå…ˆè™•ç†è¨ªå®¢æ¨¡å¼
        if (isVisitorMode) {
            if (loading.data) { /* ...é¡¯ç¤ºè¼‰å…¥ä¸­... */ }
            if (visitorError) { /* ...é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯... */ }
            if (visitorData) {
                 // ... è¿”å›è¨ªå®¢æ¨¡å¼çš„ JSX ...
                 const { className, students: visitorStudents, assignments: visitorAssignments, lastUpdated } = visitorData;
                 const formattedDate = /* ... */;
                 const visitorSortedAssignments = /* ... */;
                 return (
                    <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                        {/* ... è¨ªå®¢æ¨¡å¼çš„ Header å’Œ Main ... */}
                        <header>...</header>
                        <main>
                            <div className="flex justify-end gap-4 mb-2">
                               <Button onClick={() => handleCopyAllUnsubmitted()} className="bg-pink-500 hover:bg-pink-600">è¤‡è£½å…¨ç­æœªç¹³ç¸½è¡¨</Button>
                               <Button onClick={() => handleExportMailMergeCSV()} className="bg-green-600 hover:bg-green-700">åŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (CSV)</Button>
                           </div>
                            <AssignmentTable
                                students={visitorStudents || []}
                                assignments={visitorSortedAssignments}
                                /* ... å…¶ä»– props ... */
                                isVisitor={true}
                             />
                        </main>
                    </div>
                 );
            }
            return null; // è‹¥ visitorData é‚„æ²’è¼‰å…¥å®Œæˆ
        }

        // 2. è™•ç†æœªç™»å…¥ç‹€æ…‹ (é¡¯ç¤ºæ–°çš„ç™»å…¥/è¨»å†Šä»‹é¢)
        if (!user) {
            return (
                <div className="flex flex-col items-center justify-center min-h-screen bg-indigo-50 px-4 py-8">
                    <div className="text-center p-8 bg-white rounded-2xl shadow-xl max-w-md w-full">
                        <h1 className="text-3xl font-extrabold text-indigo-700 mb-2">ä½œæ¥­ç¹³äº¤è¿½è¹¤ç¸½è¡¨</h1>
                        <p className="text-gray-600 mb-6">ä¸€å€‹ç‚ºè€å¸«è¨­è¨ˆçš„é›²ç«¯åŒæ­¥å·¥å…·</p>
                        <form onSubmit={isRegistering ? handleEmailSignUp : handleEmailSignIn} className="space-y-4 mb-6">
                           {/* ... Email, Password è¼¸å…¥æ¡† ... */}
                            <Input id="email" type="email" label="é›»å­éƒµä»¶" value={email} onChange={(e)=> setEmail(e.target.value)} required={true} />
                            <Input id="password" type="password" label="å¯†ç¢¼" value={password} onChange={(e)=> setPassword(e.target.value)} required={true} />
                            <Button type="submit" className="w-full bg-blue-600 hover:bg-blue-700" disabled={isSaving}>
                                {isSaving ? 'è™•ç†ä¸­...' : (isRegistering ? 'è¨»å†Šæ–°å¸³è™Ÿ' : 'ç™»å…¥')}
                            </Button>
                        </form>
                        <p className="text-sm text-gray-600 mb-4">
                            {isRegistering ? 'å·²ç¶“æœ‰å¸³è™Ÿäº†ï¼Ÿ' : 'é‚„æ²’æœ‰å¸³è™Ÿå—ï¼Ÿ'}
                            <button onClick={() => { setIsRegistering(!isRegistering); setLoginError(''); }} className="font-medium text-indigo-600 hover:text-indigo-500 ml-1">
                                {isRegistering ? 'é»æ­¤ç™»å…¥' : 'é»æ­¤è¨»å†Š'}
                            </button>
                        </p>
                        <div className="relative my-6">{/* ...åˆ†éš”ç·š... */}</div>
                        <button onClick={handleSignIn} className="w-full flex items-center justify-center gap-3 px-6 py-3 border border-gray-300 text-base font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition duration-150">
                            <svg className="w-6 h-6" viewBox="0 0 48 48">...</svg> ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
                        </button>
                        {loginError && <p className="mt-4 text-sm text-red-600 bg-red-100 p-3 rounded-lg">{loginError}</p>}
                    </div>
                </div>
            );
        }

        // 3. è™•ç†å·²ç™»å…¥ç‹€æ…‹ (é¡¯ç¤ºä¸»æ‡‰ç”¨ç¨‹å¼ä»‹é¢)
        const activeClass = classes.find(c => c.id === activeClassId);
        const activeClassName = activeClass?.name || "ç­ç´š";

        return (
            <div className="min-h-screen bg-gray-100 font-sans p-4 sm:p-6">
                {notification && (/* ...é€šçŸ¥... */)}
                <Modal isOpen={isHelpModalOpen} /* ... */ >{/* ...èªªæ˜å…§å®¹... */}</Modal>
                <Modal isOpen={statusChangeModal.isOpen} /* ... */ >{/* ...ç‹€æ…‹æŒ‰éˆ•... */}</Modal>
                <Modal isOpen={!!modal.type} /* ... */ >{/* ...ç·¨è¼¯/æ–°å¢è¡¨å–®... */}</Modal>
                <Modal isOpen={isClearCompletedModalOpen} /* ... */ >{/* ...æ¸…é™¤ç¢ºèª... */}</Modal>

                <header className="bg-white rounded-xl shadow-lg p-6 mb-6">
                   {/* ... æ¨™é¡Œã€ç™»å‡ºæŒ‰éˆ•ã€èªªæ˜ ... */}
                    <div className="flex flex-wrap justify-between items-center gap-4">
                       {/* ... */}
                       <div className="flex items-center gap-3">
                            <span className="text-sm text-gray-600">æ­¡è¿, {user.displayName || user.email || user.uid}</span> {/* é¡¯ç¤º uid ä»¥ä¾¿ç¢ºèª */}
                            <button onClick={handleSignOut} className="text-sm text-red-500 hover:underline">ç™»å‡º</button>
                        </div>
                    </div>
                    {/* ... èªªæ˜æ–‡å­— ... */}
                    <div className="mt-4 border-t pt-4"> {/* ... ç­ç´šæŒ‰éˆ• ... */} </div>
                </header>

                {loading.classes ? <p>...</p> : !activeClassId && user ? (
                    <div className="p-10 bg-white ...">{/* ... æç¤ºæ–°å¢ç­ç´š ... */}</div>
                ) : (
                    <main>
                        <div className="flex flex-wrap justify-between items-center gap-x-4 gap-y-2 mb-2">
                             <h2 className="text-2xl font-bold text-gray-800">{activeClassName}</h2>
                             <div className="flex flex-wrap items-center gap-4">
                               {/* ... æ–°å¢ä½œæ¥­ã€è¤‡è£½ã€åŒ¯å‡ºã€æ¸…é™¤æŒ‰éˆ• ... */}
                                <Button onClick={handleExportMailMergeCSV} className="bg-green-600 hover:bg-green-700">åŒ¯å‡ºå‚¬ç¹³ç¸½è¡¨ (CSV)</Button>
                                {/* ... */}
                             </div>
                        </div>
                        {loading.data ? <p>...</p> : (
                            <>
                                <AssignmentTable students={students} assignments={sortedAssignments} /* ... */ />
                                <div className="mt-4 flex gap-4">{/* ... æ–°å¢å­¸ç”ŸæŒ‰éˆ• ... */}</div>
                            </>
                        )}
                    </main>
                )}
            </div>
        );
    } // App å‡½æ•¸çµæŸ
    
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
    </script>
    <script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('/service-worker.js') // ç¢ºä¿è·¯å¾‘æ˜¯æ ¹ç›®éŒ„
        .then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        })
        .catch(error => {
          console.log('ServiceWorker registration failed: ', error);
        });
    });
  }
</script>
</body>
</html>

